<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics PackManager - Órdenes Activas</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-size: 12px;
            background-color: #f0f2f5;
            color: #333;
        }

        /* === INICIO: NUEVAS ANIMACIONES DE PARPADEO === */
        @keyframes blinker-orange {
            50% {
                background-color: #ff8c00; /* Naranja Neón */
                color: #ffffff;
                font-weight: bold;
            }
        }
        .flash-orange {
            animation: blinker-orange 2s linear infinite;
        }

        @keyframes blinker-red {
            50% {
                background-color: #ff0000; /* Rojo Neón */
                color: #ffffff;
                font-weight: bold;
            }
        }
        .flash-red {
            animation: blinker-red 0.8s linear infinite;
        }
        /* === FIN: NUEVAS ANIMACIONES DE PARPADEO === */

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .header-left {
            flex-grow: 1;
            min-width: 360px;
        }
        h1 {
            color: #1c2e4a;
            text-align: left;
            margin: 0 0 0 0;
            font-size: 3em;
        }
        .subtitle {
            font-size: 10px;
            font-style: italic;
            color: #6c757d;
            text-align: left;
            margin: 4px 0 20px 2px;
        }
        .timer-section {
            min-width: 280px;
            margin-left: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 13px;
            color: #444;
            background: #f3f5f7;
            padding: 8px 14px;
            border-radius: 10px;
            box-shadow: 0 2px 7px rgba(0,0,0,0.05);
            margin-top: 12px;
        }
        .timer-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .timer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .timer-minutes-input {
            width: 36px;
            padding: 4px 6px;
            border-radius: 5px;
            border: 1px solid #bbb;
            font-size: 1em;
            text-align: right;
        }
        .timer-btn {
            background-color: #1c2e4a;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            padding: 5px 12px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .timer-btn.timer-stop {
            background: #d9534f;
        }
        .timer-btn:active { background: #0056b3; }
        .timer-display {
            font-family: monospace;
            font-size: 1.4em;
            min-width: 55px;
            text-align: right;
            color: #1c2e4a;
            font-weight: bold;
        }
        
        .main-controls-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }

        .controls-container {
            flex-grow: 1;
            max-width: 1250px;
        }

        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 10px 18px;
            margin-bottom: 18px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            min-width: 130px;
        }
        .filter-group label {
            font-size: 1em;
            font-weight: bold;
            color: #555;
            margin-left: 2px;
        }
        .filter-select {
            padding: 7px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            font-family: 'Arial Narrow', Arial, sans-serif;
            background-color: white;
            min-width: 110px;
        }
        .update-btn {
            background: #77dd77;
            color: #222;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            padding: 8px 18px;
            font-size: 1.2em;
            margin-right: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .update-btn:active { background: #5fc95f; }
        .default-filters-btn {
            background: #eee;
            color: #444;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            padding: 8px 18px;
            font-size: 1.1em;
            cursor: pointer;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        .buttons-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 12px 16px;
            margin: 6px 0 18px 0;
        }
        .toggle-btn, .action-btn {
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-weight: 700;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.2s;
        }
        .toggle-btn { background-color: #007bff; }
        .toggle-btn:hover { background-color: #0056b3; }
        .toggle-btn.active { background-color: #28a745; }
        
        .action-btn { background-color: #000000; color: #FFFFFF; }
        .action-btn:hover { background-color: #333333; }
        .action-btn.active { background-color: #6f42c1; }

        .multiselect-filter, .multiselect-cell {
            position: relative;
        }
        .multiselect-btn {
            padding: 7px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            font-family: 'Arial Narrow', Arial, sans-serif;
            background-color: white;
            min-width: 110px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            white-space: normal; 
            overflow: visible;
            text-overflow: clip;
        }
        .multiselect-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .multiselect-content label {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        .multiselect-content label:hover {
            background-color: #f1f1f1;
        }
        .multiselect-content input {
            margin-right: 8px;
        }
        .multiselect-content label.disabled {
            color: #aaa;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .multiselect-cell .multiselect-btn {
            background: transparent;
            border: none;
            text-align: center;
            font-weight: bold;
        }
        .multiselect-cell .multiselect-content {
            left: 50%;
            transform: translateX(-50%);
        }

        .table-container { flex-grow: 1; overflow: hidden; display: flex; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .table-wrapper { width: 100%; overflow-y: auto; }
        table { width: 100%; border-spacing: 0; background-color: #ffffff; table-layout: fixed; }
        thead th {
            position: sticky;
            top: 0;
            background-color: #1c2e4a;
            color: #ffffff;
            z-index: 2;
            font-size: 1.1em;
            white-space: normal;
            text-align: center;
        }
        th, td {
            padding: 8px 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            white-space: normal;
            vertical-align: top;
        }
        th:nth-child(1), td:nth-child(1) { width: 5%; }
        th:nth-child(2), td:nth-child(2) { width: 6%; }
        th:nth-child(3), td:nth-child(3) { width: 5%; }
        th:nth-child(4), td:nth-child(4) { width: 5%; }
        th:nth-child(5), td:nth-child(5) { width: 7%; }
        th:nth-child(6), td:nth-child(6) { width: 5%; }
        th:nth-child(7), td:nth-child(7) { width: 6%; }
        th:nth-child(8), td:nth-child(8) { width: 8%; }
        th:nth-child(9), td:nth-child(9) { width: 5%; }
        th:nth-child(10), td:nth-child(10) { width: 8%; }
        th:nth-child(11), td:nth-child(11) { width: 6%; }
        th:nth-child(12), td:nth-child(12) { width: 7%; }
        th:nth-child(13), td:nth-child(13) { width: 4%; }
        th:nth-child(14), td:nth-child(14) { width: 4%; }
        th:nth-child(15), td:nth-child(15) { width: 4%; }
        th:nth-child(16), td:nth-child(16) { width: 4%; }
        th:nth-child(17), td:nth-child(17) { width: 6%; }
        th:nth-child(18), td:nth-child(18) { width: 4%; }
        th:nth-child(19), td:nth-child(19) { width: 4%; }
        th:nth-child(20), td:nth-child(20) { width: 4%; }
        th:nth-child(21), td:nth-child(21) { width: 7%; }
        th:nth-child(22), td:nth-child(22) { width: 8%; }
        th:nth-child(23), td:nth-child(23) { width: 4%; }
        th:nth-child(24), td:nth-child(24) { width: 5%; }
        th:nth-child(25), td:nth-child(25) { width: 4%; }
        th:nth-child(26), td:nth-child(26) { width: 4%; }
        tbody tr:hover { background-color: #e9ecef; }
        td[style*="background-color"] { font-weight: bold; }
        .status { font-weight: 700; padding: 4px 7px; border-radius: 10px; text-transform: uppercase; display: inline-block; text-align: center; }
        .status-closed { background-color: #6c757d; color: white; } .status-open { background-color: #28a745; color: white; }
        .status-done { background-color: #28a745; color: white; } .status-partially { background-color: #007bff; color: white; } .status-pending { background-color: #ffc107; color: #333; }
        .status-being_packed { background-color: #ccff00; color: #000; }
        .col-price, .col-address, .col-receiver, .col-boxes-pallet, .col-pound-box { display: none; }
        body.show-price .col-price { display: table-cell; }
        body.show-address .col-address { display: table-cell; }
        body.show-receiver .col-receiver { display: table-cell; }
        body.show-boxes-pallet .col-boxes-pallet { display: table-cell; }
        body.show-pound-box .col-pound-box { display: table-cell; }
        .address-link { color: #007bff; text-decoration: none; }
        .address-link:hover { text-decoration: underline; }
        .loading, .error { padding: 40px 20px; text-align: center; color: #6c757d; font-size: 1.5em; }
        .error { color: #dc3545; font-weight: bold; }
        .numeric-cell { text-align: right; }
        .totals-row { display: none; }
        .totals-row.show-on-desktop td {
            position: sticky;
            top: 40px;
            background-color: #e9ecef;
            font-weight: bold;
            z-index: 1;
            font-size: 18px;
        }
        .load-select, .priority-select {
            width: 100%;
            border: none;
            background: transparent;
            font-weight: bold;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 5px;
            cursor: pointer;
            text-align: center;
            text-align-last: center;
        }
        select:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .load-select option, .priority-select option {
            text-align: center;
        }

        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            h1 { font-size: 2em; }
            .subtitle { margin-bottom: 15px; }

            .main-controls-wrapper, .filters-bar, .buttons-bar, .header-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .controls-container { max-width: 100%; }
            .timer-section { align-items: center; margin: 10px 0; width: 100%; box-sizing: border-box;}
            .filter-group, .update-btn, .default-filters-btn, .toggle-btn, .action-btn {
                width: 100%;
            }
            .filter-select, .multiselect-btn { width: 100%; box-sizing: border-box; }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .totals-row { display: none !important; }

            tr {
                border: 1px solid #ccc;
                margin-bottom: 15px;
                border-radius: 8px;
                background-color: #fff;
            }
            
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
                white-space: normal;
                width: 100% !important;
                box-sizing: border-box;
            }

            td:before {
                position: absolute;
                top: 50%;
                left: 10px;
                transform: translateY(-50%);
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                content: attr(data-label);
            }

            td:nth-of-type(1):before { content: "COMMERCIAL STATUS"; }
            td:nth-of-type(2):before { content: "PACKING STATUS"; }
            td:nth-of-type(3):before { content: "LINE"; }
            td:nth-of-type(4):before { content: "PRIORITY"; }
            td:nth-of-type(5):before { content: "LOAD"; }
            td:nth-of-type(6):before { content: "SHIP DATE"; }
            td:nth-of-type(7):before { content: "MARKETER"; }
            td:nth-of-type(8):before { content: "ORDER #"; }
            td:nth-of-type(9):before { content: "PACK STYLE"; }
            td:nth-of-type(10):before { content: "LABEL"; }
            td:nth-of-type(11):before { content: "PROD. METHOD"; }
            td:nth-of-type(12):before { content: "%"; }
            .col-price:before { content: "PRICE"; }
            td:nth-of-type(14):before { content: "REQUEST"; }
            td:nth-of-type(15):before { content: "ASSIGNED"; }
            td:nth-of-type(16):before { content: "PENDING"; }
            td:nth-of-type(17):before { content: "BALANCE POUNDS"; }
            td:nth-of-type(18):before { content: "AVAIL. PALLETS"; }
            td:nth-of-type(19):before { content: "AVAIL. BOXES"; }
            td:nth-of-type(20):before { content: "SHIPPED"; }
            .col-receiver:before { content: "RECEIVER"; }
            .col-address:before { content: "ADDRESS"; }
            td:nth-of-type(23):before { content: "ORDER ID"; }
            td:nth-of-type(24):before { content: "STANDARD ID"; }
            .col-boxes-pallet:before { content: "BOXES PALLET"; }
            .col-pound-box:before { content: "POUND BOX"; }

            td[style*="padding:0"] { padding-left: 0; }
            td[style*="padding:0"]:before { left: 10px; padding-left: 0; }
            .load-select, .priority-select { width: 50%; float: right; font-size: 1.1em; }
            .address-link { font-size: 0.9em; }

            body.show-price .col-price,
            body.show-address .col-address,
            body.show-receiver .col-receiver,
            body.show-boxes-pallet .col-boxes-pallet,
            body.show-pound-box .col-pound-box {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <div class="header-left">
                <h1>Dynamics PackManager</h1>
                <p class="subtitle">Design & Development by Mentes Inquietas 2025</p>
            </div>
            <div class="timer-section" id="timerSection">
                <div class="timer-title">Auto refresh</div>
                <div class="timer-controls">
                    <input type="number" min="1" max="120" id="timerMinutes" class="timer-minutes-input" value="5">
                    <span>min</span>
                    <button id="timerBtn" class="timer-btn">Play</button>
                    <div class="timer-display" id="timerDisplay">-</div>
                </div>
            </div>
        </div>
        
        <div class="main-controls-wrapper">
            <div class="controls-container">
                <div class="filters-bar">
                    <button id="updateBtn" class="update-btn">Update</button>
                    <button id="defaultFiltersBtn" class="default-filters-btn">Default Filters</button>
                    <div class="filter-group">
                        <label for="commercialStatusFilter">Commercial Status</label>
                        <select id="commercialStatusFilter" class="filter-select">
                            <option value="all">All</option>
                            <option value="open" selected>Open</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="packingStatusFilter">Packing Status</label>
                        <select id="packingStatusFilter" class="filter-select">
                            <option value="all" selected>All</option>
                            <option value="pending">Pending</option>
                            <option value="being_packed">Being Packed</option>
                            <option value="partially">Partially</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="loadFilter">Load</label>
                        <select id="loadFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                    <div class="filter-group">
                        <label>Ship Date</label>
                        <div class="multiselect-filter">
                            <button id="shipDateFilterBtn" class="multiselect-btn">All</button>
                            <div id="shipDateFilterContent" class="multiselect-content"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="timeframeFilter">Timeframe</label>
                        <select id="timeframeFilter" class="filter-select"></select>
                    </div>
                    <div class="filter-group">
                        <label for="marketerFilter">Marketer</label>
                        <select id="marketerFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="orderNumberFilter">Order #</label>
                        <select id="orderNumberFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="packStyleFilter">Pack Style</label>
                        <select id="packStyleFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="labelFilter">Label</label>
                        <select id="labelFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="productionMethodFilter">Prod. Method</label>
                        <select id="productionMethodFilter" class="filter-select"><option value="all">All</option></select>
                    </div>
                </div>
                <div class="buttons-bar">
                    <button id="setLineBtn" class="action-btn">Set Line</button>
                    <button id="setPriorityBtn" class="action-btn">Set Priority</button>
                    <button id="setLoadBtn" class="action-btn">Set Load</button>
                    <button id="setAllBtn" class="action-btn">Set All</button>
                    <button id="togglePriceBtn" class="toggle-btn">Show Price</button>
                    <button id="toggleAddressBtn" class="toggle-btn">Show Address</button>
                    <button id="toggleReceiverBtn" class="toggle-btn">Show Receiver</button>
                    <button id="toggleBoxesPalletBtn" class="toggle-btn">Show Boxes Pallet</button>
                    <button id="togglePoundBoxBtn" class="toggle-btn">Show Pound Box</button>
                </div>
            </div>
            <div class="info-panel-placeholder">
            </div>
        </div>

        <div id="table-container" class="table-container"><p class="loading">Cargando órdenes...</p></div>
    </div>
    <script>
        // ========== GLOBAL STATE ==========
        let unlockedColumns = { line: false, priority: false, load: false };
        let timerInterval = null, timerRunning = false, timerSeconds = 0;
        let allOrders = [], lineAssignments = {}, priorityAssignments = {}, selectedShipDates = new Set();
        const { DateTime } = luxon;
        const dateFormat = 'M/d/yyyy';
        const ALL_LINES = ['LINE 1', 'LINE 2', 'LINE 3', 'LINE 4'];
        const LOAD_COLORS = [ { background: '#333333', text: '#FFFFFF' }, { background: '#999999', text: '#000000' } ];
        
        // ========== DOM ELEMENTS ==========
        const tableContainer = document.getElementById('table-container');
        const filters = {
            commercialStatus: document.getElementById('commercialStatusFilter'),
            packingStatus: document.getElementById('packingStatusFilter'),
            timeframe: document.getElementById('timeframeFilter'),
            marketer: document.getElementById('marketerFilter'),
            orderNumber: document.getElementById('orderNumberFilter'),
            packStyle: document.getElementById('packStyleFilter'),
            label: document.getElementById('labelFilter'),
            productionMethod: document.getElementById('productionMethodFilter'),
            load: document.getElementById('loadFilter')
        };
        const filterKeys = Object.keys(filters);

        // ========== AUTH & LOCKING ==========
        async function handleAuthAction(type) {
            const isCurrentlyUnlocked = (type === 'all') ? (unlockedColumns.line && unlockedColumns.priority && unlockedColumns.load) : unlockedColumns[type];
            if (isCurrentlyUnlocked) {
                if (type === 'all') { unlockedColumns.line = unlockedColumns.priority = unlockedColumns.load = false; } else { unlockedColumns[type] = false; }
                updateActionButtonsState();
                applyFiltersAndRender();
            } else {
                const password = prompt(`Enter password to unlock "${type}":`);
                if (password === null) return;
                try {
                    const response = await fetch('/api/verify-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, password }) });
                    const result = await response.json();
                    if (result.success) {
                        if (type === 'all') { unlockedColumns.line = unlockedColumns.priority = unlockedColumns.load = true; } else { unlockedColumns[type] = true; }
                        updateActionButtonsState();
                        applyFiltersAndRender();
                    } else { alert('Invalid password'); }
                } catch (error) { console.error('Error during password verification:', error); alert('An error occurred.'); }
            }
        }
        function updateActionButtonsState() {
            document.getElementById('setLineBtn').classList.toggle('active', unlockedColumns.line);
            document.getElementById('setLineBtn').textContent = unlockedColumns.line ? 'Block Line' : 'Set Line';
            document.getElementById('setPriorityBtn').classList.toggle('active', unlockedColumns.priority);
            document.getElementById('setPriorityBtn').textContent = unlockedColumns.priority ? 'Block Priority' : 'Set Priority';
            document.getElementById('setLoadBtn').classList.toggle('active', unlockedColumns.load);
            document.getElementById('setLoadBtn').textContent = unlockedColumns.load ? 'Block Load' : 'Set Load';
            const allUnlocked = unlockedColumns.line && unlockedColumns.priority && unlockedColumns.load;
            document.getElementById('setAllBtn').classList.toggle('active', allUnlocked);
            document.getElementById('setAllBtn').textContent = allUnlocked ? 'Block All' : 'Set All';
        }

        // ========== TIMER ==========
        function formatTimer(sec) { if (!sec || sec <= 0) return "-"; let m = Math.floor(sec / 60); let s = sec % 60; return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s; }
        function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds); }
        function stopTimer(reset=true) { timerRunning = false; clearInterval(timerInterval); timerInterval = null; document.getElementById('timerBtn').textContent = 'Play'; document.getElementById('timerBtn').classList.remove('timer-stop'); document.getElementById('timerMinutes').disabled = false; if (reset) { document.getElementById('timerDisplay').textContent = '-'; } }
        function startTimer() { if (timerRunning) return; timerSeconds = Math.max(1, parseInt(document.getElementById('timerMinutes').value,10)||5) * 60; timerRunning = true; document.getElementById('timerBtn').textContent = 'Stop'; document.getElementById('timerBtn').classList.add('timer-stop'); document.getElementById('timerMinutes').disabled = true; updateTimerDisplay(); timerInterval = setInterval(() => { timerSeconds--; updateTimerDisplay(); if (timerSeconds <= 0) { refreshData(); timerSeconds = Math.max(1, parseInt(document.getElementById('timerMinutes').value,10)||5) * 60; updateTimerDisplay(); } }, 1000); }

        // ========== DATA HANDLING & LOGIC ==========
        function genericSave(endpoint, payload) {
            return fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        
        function handleSaveResponse(promises) {
            Promise.all(promises)
            .then(responses => {
                const failed = responses.filter(r => !r.ok);
                if (failed.length > 0) {
                    alert(`Error guardando datos. La página puede estar desincronizada. Por favor, recargue.`);
                    console.error("Errores de guardado:", failed);
                }
            })
            .catch(error => {
                alert(`Error de red al guardar. Por favor, recargue.`);
                console.error("Error de red:", error);
            });
        }

        function handleLineChange(orderId, standardId, selectedLines) {
            const key = `${orderId}-${standardId}`;
            
            if (selectedLines && selectedLines.length > 0) {
                lineAssignments[key] = selectedLines;
            } else {
                delete lineAssignments[key];
            }
            applyFiltersAndRender();

            const payloadForServer = { assignmentKey: key, lines: selectedLines || [] };
            
            handleSaveResponse([ genericSave('/api/lines', payloadForServer) ]);
        }

        function resequencePriorities() { 
            const sortedLoads = Object.entries(priorityAssignments).sort(([, a], [, b]) => a - b).map(([lId]) => lId);
            const final = {};
            sortedLoads.forEach((lId, i) => { final[lId] = i + 1; });
            priorityAssignments = final;
            return final;
        }

        function handlePriorityChange(loadId, newPriorityStr) {
            const newP = newPriorityStr ? parseInt(newPriorityStr, 10) : null;
            const oldP = priorityAssignments[loadId];
            if (newP === oldP) return;

            if (newP) {
                for (const lId in priorityAssignments) {
                    if (priorityAssignments[lId] >= newP) priorityAssignments[lId]++;
                }
                priorityAssignments[loadId] = newP;
            } else {
                delete priorityAssignments[loadId];
            }
            
            const finalPriorities = resequencePriorities();
            applyFiltersAndRender();
            handleSaveResponse([ genericSave('/api/priorities', finalPriorities) ]);
        }

        function handleLoadChange(orderId, newLoad) {
            const target = allOrders.find(o => o.id_marketer_order === parseInt(orderId, 10));
            if (!target || target.load === newLoad) return;
            const siblings = allOrders.filter(o => o.order_number === target.order_number);
            const updates = [];
            siblings.forEach(s => {
                s.load = newLoad;
                updates.push({ orderId: s.id_marketer_order, load: newLoad || null });
            });
            applyFiltersAndRender();
            
            handleSaveResponse([ genericSave('/api/loads', { updates }) ]);
        }
        
        function getNextLoadId(id) { if (!id) return 'A'; let carry = true, chars = id.split(''); for (let i = chars.length - 1; i >= 0 && carry; i--) { if (chars[i] === 'Z') { chars[i] = 'A'; carry = true; } else { chars[i] = String.fromCharCode(chars[i].charCodeAt(0) + 1); carry = false; } } if (carry) chars.unshift('A'); return chars.join(''); }
        function compareLoads(a, b) { const la = a || 'ZZZ', lb = b || 'ZZZ'; return la.length !== lb.length ? la.length - lb.length : la.localeCompare(lb); }
        function getPackingStatus(order) { 
            const key = `${order.id_marketer_order}-${order.codigo_producto}`; 
            const lines = lineAssignments[key]; 
            if (lines && Array.isArray(lines) && lines.length > 0) return 'being_packed'; 
            const req = (parseFloat(order.cantidad_solicitada) || 0) / (parseFloat(order.cajas_por_pallet) || 1), ass = (parseFloat(order.cantidad_asignada) || 0) / (parseFloat(order.cajas_por_pallet) || 1), ship = (parseFloat(order.cantidad_despachada) || 0) / (parseFloat(order.cajas_por_pallet) || 1); if ((req > 0 && ass >= req) || (req > 0 && req.toFixed(2) === ship.toFixed(2))) return 'done'; if (ass > 0) return 'partially'; return 'pending'; 
        }

        // ========== FILTERING & RENDERING ==========
        function applyFiltersAndRender() {
            const selections = {}; filterKeys.forEach(k => { selections[k] = filters[k].value; });
            let filtered = allOrders.filter(o => filterKeys.every(k => checkMatch(o, k, selections[k])));
            if (selectedShipDates.size > 0) { filtered = filtered.filter(o => selectedShipDates.has(o.fecha_envio)); }
            if (filters.load.value !== "all") { filtered = filtered.filter(o => o.load === filters.load.value); const seen = new Set(); filtered = filtered.filter(o => { const key = `${o.id_marketer_order}-${o.codigo_producto}`; if (seen.has(key)) return false; seen.add(key); return true; }); }
            filterKeys.forEach(k => { if (k === 'commercialStatus' || k === 'packingStatus') return; const relevant = allOrders.filter(o => filterKeys.every(fk => fk === k ? true : checkMatch(o, fk, selections[fk]))); populateFilterOptions(k, relevant, selections[k]); });
            populateShipDateFilter(filtered);
            renderTable(filtered);
        }
        function checkMatch(order, key, value) {
            if (value === 'all' || value === 'all_time' || !value) return true;
            switch (key) {
                case 'commercialStatus': return (value === 'open' ? order.estado_marketer_order === 'activa' : order.estado_marketer_order === 'cerrada');
                case 'packingStatus': return getPackingStatus(order) === value;
                case 'timeframe':
                    const now = DateTime.now().startOf('day'), orderDate = DateTime.fromFormat(order.fecha_envio, dateFormat).startOf('day'); if (!orderDate.isValid) return false;
                    switch (value) {
                        case 'today_past': return orderDate <= now; case 'through_tomorrow': return orderDate <= now.plus({ days: 1 }); case 'tomorrow': return orderDate.hasSame(now.plus({ days: 1 }), 'day'); case 'this_week': return orderDate.hasSame(now, 'week'); case 'next_week': return orderDate.hasSame(now.plus({ weeks: 1 }), 'week');
                        default: if (value.startsWith('20')) { const [y, w] = value.split('-W'); return orderDate.weekYear === parseInt(y) && orderDate.weekNumber === parseInt(w); } return false;
                    }
                case 'marketer': return order.marketer === value; case 'packStyle': return order.descripcion === value; case 'label': return order.label === value; case 'productionMethod': return order.formacion === value; case 'orderNumber': return order.order_number === value; case 'load': return value === 'all' ? true : (order.load || '') === value;
                default: return true;
            }
        }
        function populateFilterOptions(key, relevantData, selectedValue) {
            const select = filters[key];
            if (key === 'timeframe') {
                const timeframeStaticOptions = [ { value: "all_time", text: "All Time" }, { value: "today_past", text: "Today & Past" }, { value: "through_tomorrow", text: "Through Tomorrow" }, { value: "tomorrow", text: "Tomorrow" }, { value: "this_week", text: "This Week" }, { value: "next_week", text: "Next Week" } ];
                select.innerHTML = ''; const weekOpts = new Map();
                relevantData.forEach(o => { const d = DateTime.fromFormat(o.fecha_envio, dateFormat); if (d.isValid) { const k = `${d.weekYear}-W${d.weekNumber}`; if (!weekOpts.has(k)) { const start = d.startOf('week'), end = d.endOf('week'); weekOpts.set(k, { label: `Week ${d.weekNumber} (${start.toFormat('MMM d')} - ${end.toFormat('MMM d')})`, value: k, start }); } } });
                timeframeStaticOptions.forEach(opt => { const el = document.createElement('option'); el.value = opt.value; el.textContent = opt.text; select.appendChild(el); });
                Array.from(weekOpts.values()).sort((a,b) => a.start - b.start).forEach(w => { const el = document.createElement('option'); el.value = w.value; el.textContent = w.label; select.appendChild(el); });
            } else if (key === 'load') {
                select.innerHTML = '<option value="all">All</option>';
                Array.from(new Set(allOrders.map(o => o.load).filter(Boolean))).sort(compareLoads).forEach(load => { const el = document.createElement('option'); el.value = load; el.textContent = load; select.appendChild(el); });
            } else {
                let dataKey; if (key === 'packStyle') dataKey = 'descripcion'; else if (key === 'productionMethod') dataKey = 'formacion'; else if (key === 'orderNumber') dataKey = 'order_number'; else dataKey = key;
                const opts = [...new Set(relevantData.map(o => o[dataKey]).filter(Boolean))].sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));
                select.innerHTML = '<option value="all">All</option>'; opts.forEach(opt => { const el = document.createElement('option'); el.value = opt; el.textContent = opt; select.appendChild(el); });
            }
            select.value = Array.from(select.options).map(o => o.value).includes(selectedValue) ? selectedValue : (key === 'timeframe' ? 'all_time' : 'all');
        }
        function renderTable(data) {
            const getSortString = o => { 
                const ps = getPackingStatus(o);
                const ip = ps === 'being_packed';
                const u = ip ? '1' : '2';
                const key = `${o.id_marketer_order}-${o.codigo_producto}`;
                const l = ip ? (lineAssignments[key]?.[0] || 'Z') : 'Z';
                const p = priorityAssignments[o.load] || 999;
                const lo = o.load || 'ZZZ';
                const sd = DateTime.fromFormat(o.fecha_envio, dateFormat).toISODate() || '9999-12-31';
                const m = o.marketer || '~';
                const on = String(o.order_number || '~').padStart(10, '0');
                return `${u}-${l}-${p.toString().padStart(3, '0')}-${lo}-${sd}-${m}-${on}`;
            };
            const sortedData = [...data].sort((a, b) => getSortString(a).localeCompare(getSortString(b)));
            const finalData = sortedData.filter(o => (parseFloat(o.cajas_por_pallet) || 0) > 0 && (parseFloat(o.cantidad_solicitada) / (parseFloat(o.cajas_por_pallet) || 1)) > 0);
            if (finalData.length === 0) { tableContainer.innerHTML = `<p class="loading">No orders match the current filters.</p>`; return; }
            const totals = { request: 0, assigned: 0, pending: 0, balancePounds: 0, shipped: 0 };
            finalData.forEach(o => { const reqC = parseFloat(o.cantidad_solicitada) || 0, assC = parseFloat(o.cantidad_asignada) || 0, shipC = parseFloat(o.cantidad_despachada) || 0, pC = parseFloat(o.peso_por_caja) || 0, cxp = parseFloat(o.cajas_por_pallet) || 1; const reqN = reqC / cxp, assN = assC / cxp, shipN = shipC / cxp; totals.request += reqN; totals.assigned += assN; totals.pending += reqN - (assN + shipN); totals.balancePounds += (reqC - (assC + shipC)) * pC; totals.shipped += shipN; });
            const totalsRowHTML = `<tr class="totals-row show-on-desktop"><td colspan="11"></td><td></td><td class="col-price"></td><td class="numeric-cell">${totals.request.toFixed(2)}</td><td class="numeric-cell">${totals.assigned.toFixed(2)}</td><td class="numeric-cell">${totals.pending.toFixed(2)}</td><td class="numeric-cell">${totals.balancePounds.toLocaleString('en-US', {maximumFractionDigits: 0})}</td><td colspan="2"></td><td class="numeric-cell">${totals.shipped.toFixed(2)}</td><td colspan="6"></td></tr>`;
            
            const loadOwnership = new Map(); allOrders.forEach(o => { if (o.estado_marketer_order === 'activa' && o.load && !loadOwnership.has(o.load)) { loadOwnership.set(o.load, o.marketer); } });
            const allUsedLoads = Array.from(new Set(allOrders.map(o => o.load).filter(Boolean))).sort(compareLoads);
            const highestLoadInUse = allUsedLoads.length > 0 ? allUsedLoads[allUsedLoads.length - 1] : '';
            const nextAvailableGlobalLoad = getNextLoadId(highestLoadInUse);
            const occupiedLines = new Set(Object.values(lineAssignments).flat());
            const existingPriorities = Object.values(priorityAssignments);
            const maxPriority = existingPriorities.length > 0 ? Math.max(...existingPriorities) : 0;
            
            let lastProcessedLoad = null, colorIndex = 0, lastOrderNumberForColor = null;
            const dataRowsHTML = finalData.map((order, index) => {
                const isClosed = order.estado_marketer_order === 'cerrada';
                const packingStatusValue = getPackingStatus(order);
                const assignmentKey = `${order.id_marketer_order}-${order.codigo_producto}`;

                // Cálculos numéricos para la fila
                const reqC = parseFloat(order.cantidad_solicitada) || 0, assC = parseFloat(order.cantidad_asignada) || 0, shipC = parseFloat(order.cantidad_despachada) || 0, pC = parseFloat(order.peso_por_caja) || 0, cxp = parseFloat(order.cajas_por_pallet) || 1, disp = parseFloat(order.cantidad_disponible) || 0;
                const reqN = reqC/cxp, assN = assC/cxp, shipN = shipC/cxp, pendN = reqN - (assN+shipN), balP = (reqC - (assC+shipC)) * pC;
                const availP = !isClosed ? Math.floor(disp / cxp) : 0; const availB = !isClosed ? disp - (availP * cxp) : 0;

                // *** INICIO: LÓGICA DE PARPADEO ***
                let packingStatusClasses = `status status-${packingStatusValue}`;
                if (packingStatusValue === 'being_packed') {
                    const pendingPallets = Math.floor(pendN);
                    if (pendingPallets === 2) {
                        packingStatusClasses += ' flash-orange';
                    } else if (pendingPallets === 1) {
                        packingStatusClasses += ' flash-red';
                    }
                }
                const packingStatusCellHTML = `<td><span class="${packingStatusClasses}">${packingStatusValue.replace('_', ' ').toUpperCase()}</span></td>`;
                // *** FIN: LÓGICA DE PARPADEO ***

                let currentLines = lineAssignments[assignmentKey];
                if (typeof currentLines === 'string') {
                    currentLines = [currentLines];
                } else if (!Array.isArray(currentLines)) {
                    currentLines = [];
                }

                // LINE CELL LOGIC
                let lineCellHTML;
                const isLineEligible = !isClosed && ['pending', 'partially', 'being_packed'].includes(packingStatusValue);
                if (isLineEligible) {
                    const lineBtnId = `line-btn-${index}`;
                    const lineContentId = `line-content-${index}`;
                    const btnContent = currentLines.length > 0 ? currentLines.join('<br>') : '-';
                    lineCellHTML = `<td class="multiselect-cell">
                        <button id="${lineBtnId}" class="multiselect-btn">${btnContent}</button>
                        <div id="${lineContentId}" class="multiselect-content">
                        ${ALL_LINES.map(line => {
                            const isChecked = currentLines.includes(line);
                            const isOccupied = occupiedLines.has(line) && !isChecked;
                            const disabledClass = isOccupied ? 'class="disabled"' : '';
                            return `<label ${disabledClass}><input type="checkbox" value="${line}" ${isChecked ? 'checked' : ''} ${isOccupied || !unlockedColumns.line ? 'disabled' : ''}> ${line}</label>`;
                        }).join('')}
                        </div>
                    </td>`;
                } else {
                    lineCellHTML = `<td style="text-align: center; font-weight: bold;">${currentLines.join('<br>') || '-'}</td>`;
                }

                // PRIORITY & LOAD CELL LOGIC
                const currentPriority = priorityAssignments[order.load];
                let loadCellHTML;
                if (isClosed) { loadCellHTML = `<td style="text-align: center; font-weight: bold;">-</td>`; } else {
                    let loadDef = null; if (order.load) { if (lastOrderNumberForColor !== order.order_number) { if (lastProcessedLoad !== order.load) { colorIndex = 1 - colorIndex; lastProcessedLoad = order.load; } lastOrderNumberForColor = order.order_number; } loadDef = LOAD_COLORS[colorIndex]; } else { lastOrderNumberForColor = null; }
                    const marketerLoads = []; loadOwnership.forEach((owner, load) => { if (owner === order.marketer) marketerLoads.push(load); });
                    const uniqueOpts = [...new Set([...marketerLoads, nextAvailableGlobalLoad])].sort(compareLoads);
                    const isLoadDisabled = !!currentPriority || !unlockedColumns.load;
                    const loadSelectHTML = `<select class="load-select" style="color:${loadDef?.text || '#000'}" onchange="handleLoadChange('${order.id_marketer_order}', this.value)" ${isLoadDisabled ? 'disabled' : ''}><option value="">${order.load ? 'Clear' : '-'}</option>${uniqueOpts.map(l => `<option value="${l}" ${order.load === l ? 'selected' : ''}>${l}</option>`).join('')}</select>`;
                    loadCellHTML = `<td style="background-color:${loadDef?.background || 'transparent'};padding:0;">${loadSelectHTML}</td>`;
                }
                let priorityCellHTML;
                if (!isClosed && order.load && packingStatusValue !== 'being_packed') {
                    let optsHTML = `<option value="">-</option>`;
                    for(let i=1; i<=maxPriority+1; i++) { const taken = existingPriorities.includes(i) && i !== currentPriority; optsHTML += `<option value="${i}" ${currentPriority === i ? 'selected' : ''} ${taken ? 'disabled style="color:#ccc;"' : ''}>P ${i}${taken ? ' (taken)' : ''}</option>`; }
                    priorityCellHTML = `<td style="padding:0;"><select class="priority-select" onchange="handlePriorityChange('${order.load}', this.value)" ${!unlockedColumns.priority ? 'disabled' : ''}>${optsHTML}</select></td>`;
                } else { priorityCellHTML = `<td>${currentPriority ? `P ${currentPriority}` : '-'}</td>`; }

                // OTHER CELLS
                let rS = '', aS = '', pS = '', avS = '', sS = ''; if ((reqN > 0 && reqN.toFixed(2) === assN.toFixed(2)) || (reqN > 0 && reqN.toFixed(2) === shipN.toFixed(2))) rS = 'style="background-color: #77dd77;"'; if (reqN > 0 && reqN.toFixed(2) === shipN.toFixed(2)) sS = 'style="background-color: #77dd77;"'; if (assN > 0) aS = 'style="background-color: #84b6f4;"'; if (pendN > 0) pS = 'style="background-color: #ff6961;"'; if (availP > 0 || availB > 0) avS = 'style="background-color: #fdfd96;"';
                const shipDate = DateTime.fromFormat(order.fecha_envio, dateFormat), hoy = DateTime.now().startOf('day');
                const shipDateCell = `<td${shipDate.isValid && shipDate < hoy ? ' style="background-color:#fdfd96;"' : ''}>${order.fecha_envio}</td>`;
                let percentCell = '<td></td>'; if (reqN > 0) { const pct = Math.round(((assN + shipN) / reqN) * 100), r = Math.round(255 - (255 * pct / 100)); percentCell = `<td style="font-weight:bold;color:rgb(${r},0,0);">${pct}%</td>`; }
                
                return `<tr>
                    <td><span class="status status-${isClosed ? 'closed' : 'open'}">${isClosed ? 'CLOSED' : 'OPEN'}</span></td>
                    ${packingStatusCellHTML}
                    ${lineCellHTML}
                    ${priorityCellHTML}
                    ${loadCellHTML}
                    ${shipDateCell}
                    <td style="text-align:left;">${order.marketer}</td><td>${order.order_number}</td><td style="text-align:left;">${order.descripcion}</td><td style="text-align:left;">${order.label || ''}</td><td style="text-align:left;">${order.formacion || ''}</td>
                    ${percentCell}
                    <td class="col-price numeric-cell">$${(parseFloat(order.precio) || 0).toFixed(2)}</td>
                    <td class="numeric-cell" ${rS}>${reqN.toFixed(2)}</td><td class="numeric-cell" ${aS}>${assN.toFixed(2)}</td><td class="numeric-cell" ${pS}>${pendN.toFixed(2)}</td><td class="numeric-cell">${balP.toLocaleString('en-US',{maximumFractionDigits:0})}</td>
                    <td class="numeric-cell" ${avS}>${availP}</td><td class="numeric-cell" ${avS}>${availB}</td><td class="numeric-cell" ${sS}>${shipN.toFixed(2)}</td>
                    <td class="col-receiver" style="text-align:left;">${order.recibidor}</td><td class="col-address"><a href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent('2460 Wildwood RD Curtis WA 98538')}&destination=${encodeURIComponent(order.direccion_recibidor)}" target="_blank" class="address-link">${order.direccion_recibidor}</a></td>
                    <td>${order.id_marketer_order}</td><td>${order.codigo_producto}</td>
                    <td class="col-boxes-pallet numeric-cell">${order.cajas_por_pallet}</td><td class="col-pound-box numeric-cell">${order.peso_por_caja}</td>
                </tr>`;
            }).join('');
            tableContainer.innerHTML = `<div class="table-wrapper"><table><thead><tr>
                <th>COMMERCIAL STATUS</th><th>PACKING STATUS</th><th>LINE</th><th>PRIORITY</th><th>LOAD</th><th>SHIP DATE</th><th>MARKETER</th><th>ORDER #</th><th>PACK STYLE</th><th>LABEL</th><th>PROD. METHOD</th><th>%</th><th class="col-price">PRICE</th><th>REQUEST</th><th>ASSIGNED</th><th>PENDING</th><th>BALANCE POUNDS</th><th>AVAIL. PALLETS</th><th>AVAIL. BOXES</th><th>SHIPPED</th><th class="col-receiver">RECEIVER</th><th class="col-address">ADDRESS</th><th>ORDER ID</th><th>STANDARD ID</th><th class="col-boxes-pallet">BOXES PALLET</th><th class="col-pound-box">POUND BOX</th>
            </tr></thead><tbody>${totalsRowHTML}${dataRowsHTML}</tbody></table></div>`;
            
            finalData.forEach((order, index) => {
                const isClosed = order.estado_marketer_order === 'cerrada';
                const packingStatusValue = getPackingStatus(order);
                const isLineEligible = !isClosed && ['pending', 'partially', 'being_packed'].includes(packingStatusValue);
                if (isLineEligible) {
                    const btn = document.getElementById(`line-btn-${index}`);
                    const content = document.getElementById(`line-content-${index}`);
                    btn.addEventListener('click', (e) => {
                        if (!unlockedColumns.line) return; 
                        e.stopPropagation();
                        document.querySelectorAll('.multiselect-cell .multiselect-content').forEach(c => { if(c !== content) c.style.display = 'none'; });
                        content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    });
                    content.addEventListener('change', () => {
                        const selectedLines = Array.from(content.querySelectorAll('input:checked')).map(cb => cb.value);
                        handleLineChange(order.id_marketer_order, order.codigo_producto, selectedLines);
                    });
                }
            });
        }
        
        // ========== EVENT LISTENERS & INITIALIZATION ==========
        function setupEventListeners() {
            document.getElementById('timerBtn').addEventListener('click', () => { if (timerRunning) stopTimer(); else startTimer(); });
            document.getElementById('updateBtn').addEventListener('click', refreshData);
            document.getElementById('setLineBtn').addEventListener('click', () => handleAuthAction('line'));
            document.getElementById('setPriorityBtn').addEventListener('click', () => handleAuthAction('priority'));
            document.getElementById('setLoadBtn').addEventListener('click', () => handleAuthAction('load'));
            document.getElementById('setAllBtn').addEventListener('click', () => handleAuthAction('all'));
            ['Price', 'Address', 'Receiver', 'BoxesPallet', 'PoundBox'].forEach(type => {
                const btn = document.getElementById(`toggle${type}Btn`);
                btn.addEventListener('click', (e) => {
                    document.body.classList.toggle(`show-${type.toLowerCase().replace('boxespallet', 'boxes-pallet').replace('poundbox', 'pound-box')}`);
                    const newText = type.replace(/([A-Z])/g, ' $1').trim();
                    e.target.textContent = e.target.textContent.startsWith('Show') ? `Hide ${newText}` : `Show ${newText}`;
                    e.target.classList.toggle('active');
                });
            });
            Object.values(filters).forEach(filter => filter.addEventListener('change', applyFiltersAndRender));
            
            const shipDateBtn = document.getElementById('shipDateFilterBtn');
            const shipDateContent = document.getElementById('shipDateFilterContent');
            shipDateBtn.addEventListener('click', (e) => { e.stopPropagation(); shipDateContent.style.display = shipDateContent.style.display === 'block' ? 'none' : 'block'; });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multiselect-filter')) shipDateContent.style.display = 'none';
                if (!e.target.closest('.multiselect-cell')) document.querySelectorAll('.multiselect-cell .multiselect-content').forEach(c => c.style.display = 'none');
            });

            document.getElementById('defaultFiltersBtn').addEventListener('click', () => {
                filters.commercialStatus.value = 'open'; filters.packingStatus.value = 'all'; filters.timeframe.value = 'through_tomorrow';
                selectedShipDates.clear(); updateShipDateButtonText();
                Object.keys(filters).forEach(k => { if (!['commercialStatus', 'packingStatus', 'timeframe'].includes(k)) filters[k].value = 'all'; });
                applyFiltersAndRender();
            });
        }
        function populateShipDateFilter(data) {
            const content = document.getElementById('shipDateFilterContent');
            const dates = Array.from(new Set(data.map(o => o.fecha_envio))).sort((a,b) => DateTime.fromFormat(a, dateFormat) - DateTime.fromFormat(b, dateFormat));
            content.innerHTML = '';
            const allLabel = document.createElement('label'); const allCB = document.createElement('input'); allCB.type = 'checkbox'; allCB.checked = selectedShipDates.size === 0;
            allCB.onchange = (e) => { if(e.target.checked) { selectedShipDates.clear(); content.querySelectorAll('input').forEach(cb => { if (cb !== allCB) cb.checked = false; }); } updateShipDateButtonText(); applyFiltersAndRender(); };
            allLabel.append(allCB, ' (Select All)'); content.appendChild(allLabel);
            dates.forEach(date => { const label = document.createElement('label'), cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = date; cb.checked = selectedShipDates.has(date);
                cb.onchange = (e) => { if (e.target.checked) selectedShipDates.add(date); else selectedShipDates.delete(date); content.querySelector('input').checked = selectedShipDates.size === 0; updateShipDateButtonText(); applyFiltersAndRender(); };
                label.append(cb, ` ${date}`); content.appendChild(label);
            });
        }
        function updateShipDateButtonText() { const btn = document.getElementById('shipDateFilterBtn'); if (selectedShipDates.size === 0) btn.textContent = 'All'; else if (selectedShipDates.size === 1) btn.textContent = selectedShipDates.values().next().value; else btn.textContent = `${selectedShipDates.size} dates selected`; }
        function refreshData() { loadAndRenderAll(true); }
        
        function loadAndRenderAll(keepFilters) {
            const prevSelections = keepFilters ? Object.fromEntries(Object.entries(filters).map(([k,v]) => [k,v.value])) : {};
            tableContainer.innerHTML = `<p class="loading">Cargando órdenes...</p>`;
            Promise.all([
                fetch('/api/orders').then(res => res.ok ? res.json() : Promise.reject('Orders')),
                fetch('/api/loads').then(res => res.ok ? res.json() : Promise.reject('Loads')),
                fetch('/api/lines').then(res => res.ok ? res.json() : Promise.reject('Lines')),
                fetch('/api/priorities').then(res => res.ok ? res.json() : Promise.reject('Priorities'))
            ]).then(([ordersData, loadAssigns, initialLines, initialPriorities]) => {
                
                const raw = ordersData[0]?.data;
                if (!raw || !Array.isArray(raw)) throw new Error("No data in API response.");

                lineAssignments = initialLines; 
                priorityAssignments = initialPriorities;
                allOrders = raw.map(o => ({ ...o, load: loadAssigns[o.id_marketer_order] || '' }));
                let cleaned = false;
                Object.keys(priorityAssignments).forEach(lId => { const oInLoad = allOrders.filter(o => o.load === lId); if (oInLoad.length > 0 && oInLoad.every(o => getPackingStatus(o) === 'done')) { delete priorityAssignments[lId]; cleaned = true; } });
                Object.keys(lineAssignments).forEach(key => { const o = allOrders.find(o => `${o.id_marketer_order}-${o.codigo_producto}` === key); if (!o || getPackingStatus(o) === 'done') { delete lineAssignments[key]; cleaned = true; } });
                if(cleaned) { const finalPrios = resequencePriorities(); handleSaveResponse([ genericSave('/api/sync_all', { lines: lineAssignments, priorities: finalPrios }) ]); }
                allOrders = allOrders.filter(o => ['cerrada', 'activa'].includes(o.estado_marketer_order) && o.fecha_envio);
                filterKeys.forEach(k => { if (k !== 'commercialStatus' && k !== 'packingStatus') { populateFilterOptions(k, allOrders, 'all'); } });
                filters.commercialStatus.value = keepFilters && prevSelections.commercialStatus ? prevSelections.commercialStatus : 'open';
                filters.packingStatus.value = keepFilters && prevSelections.packingStatus ? prevSelections.packingStatus : 'all';
                filters.timeframe.value = keepFilters && prevSelections.timeframe ? prevSelections.timeframe : 'through_tomorrow';
                filterKeys.forEach(k => { if (!['commercialStatus', 'packingStatus', 'timeframe'].includes(k)) filters[k].value = keepFilters && prevSelections[k] ? prevSelections[k] : 'all'; });
                applyFiltersAndRender();
            }).catch(error => {
                tableContainer.innerHTML = `<p class="error"><strong>Error Crítico:</strong> ${error.toString()}</p>`;
                console.error("Error details:", error);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadAndRenderAll(false);
            updateActionButtonsState();
        });
    </script>
</body>
</html>