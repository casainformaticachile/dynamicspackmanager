<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics PackManager - Órdenes Activas</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-size: 12px;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; /* Evita el scroll en el body */
        }

        @keyframes blinker-orange {
            50% {
                background-color: #ff8c00; /* Naranja Neón */
                color: #ffffff;
                font-weight: bold;
            }
        }
        .flash-orange {
            animation: blinker-orange 2s linear infinite;
        }

        @keyframes blinker-red {
            50% {
                background-color: #ff0000; /* Rojo Neón */
                color: #ffffff;
                font-weight: bold;
            }
        }
        .flash-red {
            animation: blinker-red 0.8s linear infinite;
        }

        /* === INICIO: ESTILOS DEL NUEVO SISTEMA DE PRIORIDAD === */
        .priority-capsule {
            display: inline-flex;
            align-items: center;
            gap: 6px; /* Espacio ajustado para el icono más pequeño */
            background-color: #E6E6E6; /* --- FONDO ACTUALIZADO --- */
            color: #333;
            font-size: 16px;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 10px;
            border: 1px solid #cccccc; /* Borde actualizado */
            min-width: 30px;
            text-align: center;
            position: relative; /* Para el posicionamiento del select */
        }

        .priority-icon {
            width: 15px;  /* --- TAMAÑO REDUCIDO --- */
            height: 15px; /* --- TAMAÑO REDUCIDO --- */
        }

        /* P1 - Rojo */
        @-webkit-keyframes flash-icon-red {
            0%, 100% { fill: #D9534F; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }
        @keyframes flash-icon-red {
            0%, 100% { fill: #D9534F; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }

        /* P2 - Negro (antes Naranja) */
        @-webkit-keyframes flash-icon-black-medium {
            0%, 100% { fill: #000000; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }
        @keyframes flash-icon-black-medium {
            0%, 100% { fill: #000000; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }

        /* P3 - Negro (antes Amarillo) */
        @-webkit-keyframes flash-icon-black-slow {
            0%, 100% { fill: #000000; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }
        @keyframes flash-icon-black-slow {
            0%, 100% { fill: #000000; }
            50% { fill: #E6E6E6; } /* Actualizado al nuevo fondo */
        }

        .priority-icon.p1 {
            fill: #D9534F; /* Rojo */
            -webkit-animation: flash-icon-red 0.8s linear infinite;
            animation: flash-icon-red 0.8s linear infinite; /* Rápida */
        }
        .priority-icon.p2 {
            fill: #000000; /* Negro */
            -webkit-animation: flash-icon-black-medium 1.5s linear infinite;
            animation: flash-icon-black-medium 1.5s linear infinite; /* Media */
        }
        .priority-icon.p3 {
            fill: #000000; /* Negro */
            -webkit-animation: flash-icon-black-slow 2.5s linear infinite;
            animation: flash-icon-black-slow 2.5s linear infinite; /* Lenta */
        }
        /* === FIN: ESTILOS DEL NUEVO SISTEMA DE PRIORIDAD === */

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 20px;
            flex-shrink: 0; /* Evita que el header se encoja */
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            min-width: 360px;
        }
        h1 {
            color: #1c2e4a;
            text-align: left;
            margin: 0;
            font-size: 3em;
        }
        .subtitle {
            font-size: 10px;
            font-style: italic;
            color: #6c757d;
            text-align: left;
            margin: 4px 0 20px 2px;
        }

        /* --- ESTILOS PANEL PLEGABLE --- */
        #controls-panel {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding-top 0.5s ease-in-out;
            max-height: 1000px; /* Altura suficiente para el contenido */
            overflow: hidden;
            opacity: 1;
            position: relative;
            z-index: 10; /* Asegura que los filtros estén sobre la tabla */
            flex-shrink: 0; /* Evita que el panel se encoja */
            padding-top: 20px;
        }
        body.controls-collapsed #controls-panel {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }
        #toggle-panel-btn {
            background: #f3f5f7;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        #toggle-panel-btn:hover {
            background-color: #e9ecef;
        }
        #toggle-panel-btn svg {
            width: 24px;
            height: 24px;
            fill: #444B58;
            transition: transform 0.3s ease-in-out;
        }
        body.controls-collapsed #toggle-panel-btn svg {
            transform: rotate(180deg);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }
        .spinning {
            animation: spin 1s linear;
        }
        #updateBtn {
            background-color: #77dd77;
            border: 1px solid #6cbf6c;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        #updateBtn:hover {
            background-color: #88ee88;
        }
        #updateBtn svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        /* --- INICIO: SECCIÓN DE CONTROLES DEL HEADER --- */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 12px;
        }
        .logo-toggle-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            text-align: center;
            line-height: 1.1;
        }
        .logo-toggle-control input {
            cursor: pointer;
            margin-top: 2px;
        }
        .timer-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 13px;
            color: #444;
            background: #f3f5f7;
            padding: 8px 14px;
            border-radius: 10px;
            box-shadow: 0 2px 7px rgba(0,0,0,0.05);
        }
        .timer-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .timer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .timer-minutes-input {
            width: 36px;
            padding: 4px 6px;
            border-radius: 5px;
            border: 1px solid #bbb;
            font-size: 1em;
            text-align: right;
        }
        .timer-btn {
            background-color: #1c2e4a;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            padding: 5px 12px;
            cursor: pointer;
            font-weight: normal; /* Sin negrita */
            transition: background 0.2s;
        }
        .timer-btn.timer-stop {
            background: #d9534f;
        }
        .timer-btn:active { background: #0056b3; }
        .timer-display {
            font-family: monospace;
            font-size: 1.4em;
            min-width: 55px;
            text-align: right;
            color: #1c2e4a;
            font-weight: bold;
        }
        /* --- FIN: SECCIÓN DE CONTROLES DEL HEADER --- */
        
        .main-controls-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }

        .controls-container {
            flex-grow: 1;
            max-width: 1250px;
        }

        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 10px 18px;
            margin-bottom: 18px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            min-width: 130px;
        }
        .filter-group label {
            font-size: 1em;
            font-weight: bold;
            color: #555;
            margin-left: 2px;
            text-transform: uppercase; /* --- FILTRO EN MAYUSCULAS --- */
        }
        .filter-select {
            padding: 7px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            font-family: 'Arial Narrow', Arial, sans-serif;
            background-color: white;
            min-width: 110px;
        }
        .default-filters-btn {
            background: #eee;
            color: #444;
            font-weight: normal; /* Sin negrita */
            border: none;
            border-radius: 5px;
            padding: 8px 18px;
            font-size: 1.1em;
            cursor: pointer;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        .buttons-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 12px 16px;
            margin: 6px 0 18px 0;
        }
        .toggle-btn, .action-btn {
            font-family: 'Arial Narrow', Arial, sans-serif;
            font-weight: normal; /* Sin negrita */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.2s;
        }
        .toggle-btn { background-color: #485569; } /* --- BOTON SHOW --- */
        .toggle-btn:hover { filter: brightness(1.2); }
        .toggle-btn.active { background-color: #799EB3; } /* --- BOTON HIDE --- */
        
        .action-btn { background-color: #444B58; color: #FFFFFF; } /* --- BOTON SET --- */
        .action-btn:hover { filter: brightness(1.2); }
        .action-btn.active { background-color: #647988; } /* --- BOTON BLOCK --- */

        .multiselect-filter, .multiselect-cell {
            position: relative;
        }
        .multiselect-btn {
            padding: 7px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            font-family: 'Arial Narrow', Arial, sans-serif;
            background-color: white;
            min-width: 110px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            white-space: normal; 
            overflow: visible;
            text-overflow: clip;
        }
        .multiselect-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .multiselect-content label {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        .multiselect-content label:hover {
            background-color: #f1f1f1;
        }
        .multiselect-content input {
            margin-right: 8px;
        }
        .multiselect-content label.disabled {
            color: #aaa;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .multiselect-cell .multiselect-btn {
            background: transparent;
            border: none;
            text-align: left;
            font-weight: bold;
        }
        .multiselect-cell .multiselect-content {
            left: 50%;
            transform: translateX(-50%);
        }

        .table-container { 
            flex-grow: 1; 
            overflow: hidden; 
            display: flex; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
            margin-top: 20px;
            position: relative; /* Para el contexto de z-index */
            z-index: 1;
            min-height: 0; /* CLAVE para que flex-grow funcione con overflow */
        }
        .table-wrapper { width: 100%; overflow-y: auto; }
        table { width: 100%; border-spacing: 0; background-color: #ffffff; table-layout: fixed; }
        thead th {
            position: sticky;
            top: 0;
            background-color: #2d2d2d; /* --- TITULO COLUMNA --- */
            color: #ffffff;
            z-index: 2;
            font-size: 1.1em;
            padding: 6px 8px;
            white-space: normal;
            text-align: center;
            vertical-align: middle;
            border-bottom: none;
            font-weight: normal;
            text-transform: uppercase;
        }
        th, td {
            padding: 4px 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            white-space: normal;
            vertical-align: middle; 
        }
        
        /* === ANCHOS DE COLUMNA FINALES === */
        th:nth-child(1), td:nth-child(1) { width: 4%; }   /* Commercial Status */
        th:nth-child(2), td:nth-child(2) { width: 3.5%; } /* Packing Status */
        th:nth-child(3), td:nth-child(3) { width: 3.5%; } /* Outfeed */
        th:nth-child(4), td:nth-child(4) { width: 3.5%; } /* Priority */
        th:nth-child(5), td:nth-child(5) { width: 3.5%; } /* Load */
        th:nth-child(6), td:nth-child(6) { width: 6.0%; } /* Ship Date */
        th:nth-child(7), td:nth-child(7) { width: 7%; }   /* Marketer */
        th:nth-child(8), td:nth-child(8) { width: 6%; }   /* Order Number (un poco más ancho) */
        th:nth-child(9), td:nth-child(9) { width: 7%; }   /* Pack Style */
        th:nth-child(10), td:nth-child(10) { width: 7%; } /* Label */
        th:nth-child(11), td:nth-child(11) { width: 6.5%; } /* Production Method */
        th:nth-child(12), td:nth-child(12) { width: 4%; } /* % */
        th:nth-child(13), td:nth-child(13) { width: 4%; } /* Request */
        th:nth-child(14), td:nth-child(14) { width: 4%; } /* Assigned */
        th:nth-child(15), td:nth-child(15) { width: 4%; } /* Pending */
        th:nth-child(16), td:nth-child(16) { width: 4.5%; } /* Balance Pound */
        th:nth-child(17), td:nth-child(17) { width: 4%; } /* Available Pallets */
        th:nth-child(18), td:nth-child(18) { width: 4%; } /* Available Boxes */
        th:nth-child(19), td:nth-child(19) { width: 4%; } /* Shipped */
        .col-price, .col-receiver, .col-address, .col-boxes-pallet, .col-pound-box { width: 5%; }

        tbody tr:hover { background-color: #e9ecef; }
        
        .status {
            font-weight: normal;
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
            text-align: center;
            min-width: 30px;
            text-transform: uppercase;
        }
        .cell-tag {
            font-weight: normal;
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
            text-align: center;
            min-width: 30px;
            font-size: 16px;
        }
        
        .numeric-value {
            font-size: 14px;
            font-weight: normal;
        }
        .numeric-value.pending {
            font-weight: bold;
        }
        .order-id-subtext {
            font-weight: normal;
        }
        
        .numeric-capsule {
            font-weight: normal;
            padding: 3px 8px;
            border-radius: 8px;
            display: inline-block;
            text-align: center;
            min-width: 35px;
            font-size: 13px;
            color: #333;
            background-color: #fdfd96;
            border: 1px solid #fdfd96;
        }

        .status-closed { background-color: #6c757d; color: white; } 
        .status-open { background-color: #28a745; color: white; }
        .status-being_packed { background-color: #ccff00; color: #000; }
        
        .status-pending { background-color: #ff6961; color: white; }
        .status-partially { background-color: #fdfd96; color: #333; }
        .status-done { background-color: #77dd77; color: #333; }
        .status-shipped { background-color: #84b6f4; color: white; }

        .client-logo {
            max-height: 34px;
            max-width: 200px;
            vertical-align: middle;
        }
        .pack-style-id {
            font-weight: bold;
        }

        .progress-donut { transform: rotate(-90deg); }
        .progress-donut-bg { fill: none; stroke: #e9ecef; }
        .progress-donut-fg { fill: none; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease-out; }
        .progress-donut-text { fill: #333; font-family: 'Arial Narrow', Arial, sans-serif; font-weight: bold; text-anchor: middle; dominant-baseline: middle; }
        .progress-donut-fg.red { stroke: #dc3545; }
        .progress-donut-fg.yellow { stroke: #ffc107; }
        .progress-donut-fg.light-green { stroke: #28a745; }
        .progress-donut-fg.dark-green { stroke: #198754; }
        
        .date-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            font-weight: normal;
            color: #333;
            width: 110px;
        }
        .date-indicator .symbol {
            font-size: 1.4em;
            line-height: 1;
            color: #555;
            font-weight: bold; /* --- FLECHAS EN NEGRITA --- */
        }

        .col-price, .col-address, .col-receiver, .col-boxes-pallet, .col-pound-box,
        th.col-availability, td.col-availability { 
            display: none; 
        }
        body.show-price .col-price { display: table-cell; }
        body.show-address .col-address { display: table-cell; }
        body.show-receiver .col-receiver { display: table-cell; }
        body.show-boxes-pallet .col-boxes-pallet { display: table-cell; }
        body.show-pound-box .col-pound-box { display: table-cell; }
        body.show-availability .col-availability {
            display: table-cell;
        }

        .address-link { color: #007bff; text-decoration: none; }
        .address-link:hover { text-decoration: underline; }
        .loading, .error { padding: 40px 20px; text-align: center; color: #6c757d; font-size: 1.5em; }
        .error { color: #dc3545; font-weight: bold; }
        .numeric-cell { text-align: right; }
        
        .totals-row td {
            position: sticky;
            top: 40px; 
            background-color: #e9ecef;
            font-weight: normal;
            z-index: 1;
            font-size: 16px;
        }
        
        .load-select, .priority-select {
            width: 100%;
            border: none;
            background: transparent;
            font-weight: normal;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 0 5px;
            cursor: pointer;
            text-align: center;
            text-align-last: center;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            opacity: 0; /* Oculta el select, pero es funcional */
        }
        .tag-select-wrapper {
            position: relative;
            display: inline-block;
            vertical-align: middle;
        }
        
        .load-select option, .priority-select option { color: #000; background: #fff; }
        select:disabled { cursor: not-allowed; }

        @media (max-width: 768px) {
            html, body { overflow: auto; }
            .container { padding: 0 10px; height: auto; }
            h1 { font-size: 2em; }
            .subtitle { margin-bottom: 15px; }
            .main-controls-wrapper, .filters-bar, .buttons-bar, .header-row { flex-direction: column; align-items: stretch; gap: 12px; }
            .controls-container { max-width: 100%; }
            .header-actions { justify-content: center; flex-wrap: wrap; }
            .timer-group { align-items: center; width: 100%; box-sizing: border-box;}
            .filter-group, .default-filters-btn, .toggle-btn, .action-btn { width: 100%; }
            .filter-select, .multiselect-btn { width: 100%; box-sizing: border-box; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            .totals-row { display: none !important; }
            tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; background-color: #fff; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; white-space: normal; width: 100% !important; box-sizing: border-box; }
            td:before { position: absolute; top: 50%; left: 10px; transform: translateY(-50%); width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; content: attr(data-label); }
            body.show-price .col-price, body.show-address .col-address, body.show-receiver .col-receiver, body.show-boxes-pallet .col-boxes-pallet, body.show-pound-box .col-pound-box { display: block; }
            body.show-availability td[data-label="AVAILABLE PALLETS"], body.show-availability td[data-label="AVAILABLE BOXES"] { display: block; }
        }
    </style>
</head>
<body class="">
    <div class="container">
        <div class="header-row">
            <div class="header-left">
                <button id="toggle-panel-btn" title="Toggle Controls Panel">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 6h9v12H4V6zm11 12V6h5v12h-5z"/></svg>
                </button>
                <div>
                    <h1>DYNAMICS PACKMANAGER</h1>
                    <p class="subtitle">Design & Development by Mentes Inquietas 2025</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="logo-toggle-control">
                    <span>Show<br>Logos</span>
                    <input type="checkbox" id="showLogosCheckbox" checked>
                </div>
                <button id="updateBtn" title="Refresh Data">
                    <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                </button>
                <div class="timer-group" id="timerGroup">
                    <div class="timer-title">Auto refresh</div>
                    <div class="timer-controls">
                        <input type="number" min="1" max="120" id="timerMinutes" class="timer-minutes-input" value="5">
                        <span>min</span>
                        <button id="timerBtn" class="timer-btn">Play</button>
                        <div class="timer-display" id="timerDisplay">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="controls-panel">
            <div class="main-controls-wrapper">
                <div class="controls-container">
                    <div class="filters-bar">
                        <button id="defaultFiltersBtn" class="default-filters-btn">Default Filters</button>
                        <div class="filter-group">
                            <label for="commercialStatusFilter">Commercial Status</label>
                            <select id="commercialStatusFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="open" selected>Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="packingStatusFilter">Packing Status</label>
                            <select id="packingStatusFilter" class="filter-select">
                                <option value="all" selected>All</option>
                                <option value="pending">Pending</option>
                                <option value="being_packed">Being Packed</option>
                                <option value="partially">Partially</option>
                                <option value="done">Done</option>
                                <option value="shipped">Shipped</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="loadFilter">Load</label>
                            <select id="loadFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                        <div class="filter-group">
                            <label>Ship Date</label>
                            <div class="multiselect-filter">
                                <button id="shipDateFilterBtn" class="multiselect-btn">All</button>
                                <div id="shipDateFilterContent" class="multiselect-content"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="timeframeFilter">Timeframe</label>
                            <select id="timeframeFilter" class="filter-select"></select>
                        </div>
                        <div class="filter-group">
                            <label for="marketerFilter">Marketer</label>
                            <select id="marketerFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                        <div class="filter-group">
                            <label for="orderNumberFilter">Order Number</label>
                            <select id="orderNumberFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                        <div class="filter-group">
                            <label for="packStyleFilter">Pack Style</label>
                            <select id="packStyleFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                        <div class="filter-group">
                            <label for="labelFilter">Label</label>
                            <select id="labelFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                        <div class="filter-group">
                            <label for="productionMethodFilter">Production Method</label>
                            <select id="productionMethodFilter" class="filter-select"><option value="all">All</option></select>
                        </div>
                    </div>
                    <div class="buttons-bar">
                        <button id="setLineBtn" class="action-btn">Set Outfeed</button>
                        <button id="setPriorityBtn" class="action-btn">Set Priority</button>
                        <button id="setLoadBtn" class="action-btn">Set Load</button>
                        <button id="setAllBtn" class="action-btn">Set All</button>
                        <button id="togglePriceBtn" class="toggle-btn">Show Price</button>
                        <button id="toggleAddressBtn" class="toggle-btn">Show Address</button>
                        <button id="toggleReceiverBtn" class="toggle-btn">Show Receiver</button>
                        <button id="toggleAvailabilityBtn" class="toggle-btn">Show Availability</button>
                        <button id="toggleBoxesPalletBtn" class="toggle-btn">Show Boxes/Pallet</button>
                        <button id="togglePoundBoxBtn" class="toggle-btn">Show Lbs/Box</button>
                    </div>
                </div>
                <div class="info-panel-placeholder">
                </div>
            </div>
        </div>

        <div id="table-container" class="table-container"><p class="loading">Cargando órdenes...</p></div>
    </div>
    <script>
        // ========== GLOBAL STATE ==========
        let unlockedColumns = { line: false, priority: false, load: false, price: false };
        let timerInterval = null, timerRunning = false, timerSeconds = 0;
        let allOrders = [];
        let logoMap = {};
        let showLogos = true;
        let selectedShipDates = new Set();
        let state = {
            lines: {},
            priorities: {},
            loads: {}
        };
        const { DateTime } = luxon;
        const dateFormat = 'M/d/yyyy';
        const ALL_LINES = ['LINE 1', 'LINE 2', 'LINE 3', 'LINE 4'];
        const LOAD_COLORS = [ { background: '#333333', text: '#FFFFFF' }, { background: '#999999', text: '#000000' } ];
        
        // ========== DOM ELEMENTS ==========
        const tableContainer = document.getElementById('table-container');
        const filters = {
            commercialStatus: document.getElementById('commercialStatusFilter'),
            packingStatus: document.getElementById('packingStatusFilter'),
            timeframe: document.getElementById('timeframeFilter'),
            marketer: document.getElementById('marketerFilter'),
            orderNumber: document.getElementById('orderNumberFilter'),
            packStyle: document.getElementById('packStyleFilter'),
            label: document.getElementById('labelFilter'),
            productionMethod: document.getElementById('productionMethodFilter'),
            load: document.getElementById('loadFilter')
        };
        const filterKeys = Object.keys(filters);

        // ========== HELPER FUNCTIONS ==========
        function getInitials(name) {
            if (!name) return '';
            const words = name.split(/[ &]+/);
            if (words.length === 1) {
                return name.substring(0, 2).toUpperCase();
            }
            return words.map(w => w[0]).join('').toUpperCase().substring(0, 2);
        }

        // ========== API HELPERS ==========
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Network response was not ok', success: false }));
                    return { ...errorData, success: false };
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (data.success === undefined) {
                        data.success = true;
                    }
                    return data;
                } else {
                    return { success: true };
                }
            } catch (error) {
                const errorMessage = `Error en API (${method} ${endpoint}): ${error.message}`;
                console.error(errorMessage, error);
                return { success: false, error: errorMessage };
            }
        }

        // ========== AUTH & LOCKING ==========
        async function handleAuthAction(type) {
            const isCurrentlyUnlocked = (type === 'all') 
                ? (unlockedColumns.line && unlockedColumns.priority && unlockedColumns.load) 
                : unlockedColumns[type];
            
            if (isCurrentlyUnlocked) {
                if (type === 'all') {
                    unlockedColumns.line = unlockedColumns.priority = unlockedColumns.load = false;
                } else {
                    unlockedColumns[type] = false;
                }
                updateActionButtonsState();
                applyFiltersAndRender();
                return;
            }

            const password = prompt(`Enter password to unlock "${type}":`);
            if (password === null) return;
            
            const result = await apiCall('/api/verify-feature-password', 'POST', { feature: type, password: password });

            if (result.success) {
                if (type === 'all') {
                    unlockedColumns.line = true;
                    unlockedColumns.priority = true;
                    unlockedColumns.load = true;
                } else {
                    unlockedColumns[type] = true;
                }
            } else {
                alert('Invalid password');
                return;
            }
            
            updateActionButtonsState();
            applyFiltersAndRender();
        }

        function updateActionButtonsState() {
            document.getElementById('setLineBtn').classList.toggle('active', unlockedColumns.line);
            document.getElementById('setLineBtn').textContent = unlockedColumns.line ? 'Block Outfeed' : 'Set Outfeed';
            document.getElementById('setPriorityBtn').classList.toggle('active', unlockedColumns.priority);
            document.getElementById('setPriorityBtn').textContent = unlockedColumns.priority ? 'Block Priority' : 'Set Priority';
            document.getElementById('setLoadBtn').classList.toggle('active', unlockedColumns.load);
            document.getElementById('setLoadBtn').textContent = unlockedColumns.load ? 'Block Load' : 'Set Load';
            const allUnlocked = unlockedColumns.line && unlockedColumns.priority && unlockedColumns.load;
            document.getElementById('setAllBtn').classList.toggle('active', allUnlocked);
            document.getElementById('setAllBtn').textContent = allUnlocked ? 'Block All' : 'Set All';
        }

        async function handleToggleAuth(type) {
            const btn = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
            const className = `show-${type}`;

            if (unlockedColumns[type]) {
                document.body.classList.remove(className);
                btn.classList.remove('active');
                btn.textContent = `Show ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                unlockedColumns[type] = false;
            } else {
                const password = prompt(`Enter password to show ${type}:`);
                if (password === null) return;
                const result = await apiCall('/api/verify-price-password', 'POST', { password });
                if (result.success) {
                    unlockedColumns[type] = true;
                    document.body.classList.add(className);
                    btn.classList.add('active');
                    btn.textContent = `Hide ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                } else { alert('Invalid password'); }
            }
        }


        // ========== TIMER ==========
        function formatTimer(sec) { if (!sec || sec <= 0) return "-"; let m = Math.floor(sec / 60); let s = sec % 60; return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s; }
        function updateTimerDisplay() { document.getElementById('timerDisplay').textContent = formatTimer(timerSeconds); }
        function stopTimer(reset=true) { timerRunning = false; clearInterval(timerInterval); timerInterval = null; document.getElementById('timerBtn').textContent = 'Play'; document.getElementById('timerBtn').classList.remove('timer-stop'); document.getElementById('timerMinutes').disabled = false; if (reset) { document.getElementById('timerDisplay').textContent = '-'; } }
        function startTimer() { if (timerRunning) return; timerSeconds = Math.max(1, parseInt(document.getElementById('timerMinutes').value,10)||5) * 60; timerRunning = true; document.getElementById('timerBtn').textContent = 'Stop'; document.getElementById('timerBtn').classList.add('timer-stop'); document.getElementById('timerMinutes').disabled = true; updateTimerDisplay(); timerInterval = setInterval(() => { timerSeconds--; updateTimerDisplay(); if (timerSeconds <= 0) { refreshData(); timerSeconds = Math.max(1, parseInt(document.getElementById('timerMinutes').value,10)||5) * 60; updateTimerDisplay(); } }, 1000); }

        // ========== DATA HANDLING & LOGIC ==========
        
        async function handleLineChange(orderId, standardId, selectedLines) {
            const assignmentKey = `${orderId}-${standardId}`;
            if (selectedLines && selectedLines.length > 0) {
                state.lines[assignmentKey] = selectedLines;
            } else {
                delete state.lines[assignmentKey];
            }
            applyFiltersAndRender();
            await apiCall('/api/lines', 'POST', { assignmentKey, lines: selectedLines });
        }

        function resequencePriorities() { 
            const sortedLoads = Object.entries(state.priorities).sort(([, a], [, b]) => a - b).map(([lId]) => lId);
            const final = {};
            sortedLoads.forEach((lId, i) => { final[lId] = i + 1; });
            state.priorities = final;
            return final;
        }

        async function handlePriorityChange(loadId, newPriorityStr) {
            const newP = newPriorityStr ? parseInt(newPriorityStr, 10) : null;
            const oldP = state.priorities[loadId];
            if (newP === oldP) return;

            if (newP) {
                for (const lId in state.priorities) {
                    if (state.priorities[lId] >= newP) state.priorities[lId]++;
                }
                state.priorities[loadId] = newP;
            } else {
                delete state.priorities[loadId];
            }
            
            const finalPriorities = resequencePriorities();
            applyFiltersAndRender();
            await apiCall('/api/priorities', 'POST', finalPriorities);
        }

        async function handleLoadChange(orderId, newLoad) {
            const target = allOrders.find(o => o.id_marketer_order === parseInt(orderId, 10));
            if (!target) return;

            const siblings = allOrders.filter(o => o.order_number === target.order_number);
            const updates = [];
            siblings.forEach(s => {
                if (newLoad) {
                    state.loads[s.id_marketer_order] = newLoad;
                } else {
                    delete state.loads[s.id_marketer_order];
                }
                updates.push({ orderId: s.id_marketer_order, load: newLoad });
            });
            
            applyFiltersAndRender();
            await apiCall('/api/loads', 'POST', { updates });
        }
        
        function getNextAvailableLoad(usedLoads) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            for (const letter of alphabet) {
                if (!usedLoads.includes(letter)) {
                    return letter;
                }
            }
            let next = 'AA';
            while(usedLoads.includes(next)) {
                const lastChar = next.slice(-1);
                if (lastChar < 'Z') {
                    next = next.slice(0, -1) + String.fromCharCode(lastChar.charCodeAt(0) + 1);
                } else {
                    next += 'A';
                }
            }
            return next;
        }

        function compareLoads(a, b) { const la = a || 'ZZZ', lb = b || 'ZZZ'; return la.length !== lb.length ? la.length - lb.length : la.localeCompare(lb); }
        
        function getPackingStatus(order) {
            const shipC = parseFloat(order.cantidad_despachada) || 0;
            if (shipC > 0) return 'shipped';

            const key = `${order.id_marketer_order}-${order.codigo_producto}`; 
            const lines = state.lines[key]; 
            if (lines && Array.isArray(lines) && lines.length > 0) return 'being_packed'; 
            
            const req = (parseFloat(order.cantidad_solicitada) || 0);
            if (req === 0) return 'pending';
            
            const ass = (parseFloat(order.cantidad_asignada) || 0);
            const cxp = (parseFloat(order.cajas_por_pallet) || 1);
            const reqPallets = req / cxp;
            const assPallets = ass / cxp;

            if (assPallets >= reqPallets) return 'done';
            if (assPallets > 0) return 'partially';
            
            return 'pending'; 
        }

        // ========== FILTERING & RENDERING ==========
        function applyFiltersAndRender() {
            const selections = {}; filterKeys.forEach(k => { selections[k] = filters[k].value; });
            
            const ordersWithLoad = allOrders.map(o => ({
                ...o,
                load: state.loads[o.id_marketer_order] || ''
            }));

            let filtered = ordersWithLoad.filter(o => filterKeys.every(k => checkMatch(o, k, selections[k])));
            
            if (selectedShipDates.size > 0) { filtered = filtered.filter(o => selectedShipDates.has(o.fecha_envio)); }
            
            if (filters.load.value !== "all") { 
                filtered = filtered.filter(o => o.load === filters.load.value); 
                const seen = new Set(); 
                filtered = filtered.filter(o => { const key = `${o.id_marketer_order}-${o.codigo_producto}`; if (seen.has(key)) return false; seen.add(key); return true; }); 
            }

            filterKeys.forEach(k => { if (k === 'commercialStatus' || k === 'packingStatus') return; const relevant = ordersWithLoad.filter(o => filterKeys.every(fk => fk === k ? true : checkMatch(o, fk, selections[fk]))); populateFilterOptions(k, relevant, selections[k]); });
            
            populateShipDateFilter(filtered);
            renderTable(filtered);
        }
        function checkMatch(order, key, value) {
            if (value === 'all' || value === 'all_time' || !value) return true;
            switch (key) {
                case 'commercialStatus': return (value === 'open' ? order.estado_marketer_order === 'activa' : order.estado_marketer_order === 'cerrada');
                case 'packingStatus': return getPackingStatus(order) === value;
                case 'timeframe':
                    const now = DateTime.now().startOf('day'), orderDate = DateTime.fromFormat(order.fecha_envio, dateFormat).startOf('day'); if (!orderDate.isValid) return false;
                    switch (value) {
                        case 'today_past': return orderDate <= now; case 'through_tomorrow': return orderDate <= now.plus({ days: 1 }); case 'tomorrow': return orderDate.hasSame(now.plus({ days: 1 }), 'day'); case 'this_week': return orderDate.hasSame(now, 'week'); case 'next_week': return orderDate.hasSame(now.plus({ weeks: 1 }), 'week');
                        default: if (value.startsWith('20')) { const [y, w] = value.split('-W'); return orderDate.weekYear === parseInt(y) && orderDate.weekNumber === parseInt(w); } return false;
                    }
                case 'marketer': return order.marketer === value; case 'packStyle': return order.descripcion === value; case 'label': return order.label === value; case 'productionMethod': return order.formacion === value; case 'orderNumber': return order.order_number === value; case 'load': return value === 'all' ? true : (order.load || '') === value;
                default: return true;
            }
        }
        function populateFilterOptions(key, relevantData, selectedValue) {
            const select = filters[key];
            if (key === 'timeframe') {
                const timeframeStaticOptions = [ { value: "all_time", text: "All Time" }, { value: "today_past", text: "Today & Past" }, { value: "through_tomorrow", text: "Through Tomorrow" }, { value: "tomorrow", text: "Tomorrow" }, { value: "this_week", text: "This Week" }, { value: "next_week", text: "Next Week" } ];
                select.innerHTML = ''; const weekOpts = new Map();
                relevantData.forEach(o => { const d = DateTime.fromFormat(o.fecha_envio, dateFormat); if (d.isValid) { const k = `${d.weekYear}-W${d.weekNumber}`; if (!weekOpts.has(k)) { const start = d.startOf('week'), end = d.endOf('week'); weekOpts.set(k, { label: `Week ${d.weekNumber} (${start.toFormat('MMM d')} - ${end.toFormat('MMM d')})`, value: k, start }); } } });
                timeframeStaticOptions.forEach(opt => { const el = document.createElement('option'); el.value = opt.value; el.textContent = opt.text; select.appendChild(el); });
                Array.from(weekOpts.values()).sort((a,b) => a.start - b.start).forEach(w => { const el = document.createElement('option'); el.value = w.value; el.textContent = w.label; select.appendChild(el); });
            } else if (key === 'load') {
                select.innerHTML = '<option value="all">All</option>';
                Array.from(new Set(Object.values(state.loads))).sort(compareLoads).forEach(load => { const el = document.createElement('option'); el.value = load; el.textContent = load; select.appendChild(el); });
            } else {
                let dataKey; if (key === 'packStyle') dataKey = 'descripcion'; else if (key === 'productionMethod') dataKey = 'formacion'; else if (key === 'orderNumber') dataKey = 'order_number'; else dataKey = key;
                const opts = [...new Set(relevantData.map(o => o[dataKey]).filter(Boolean))].sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));
                select.innerHTML = '<option value="all">All</option>'; opts.forEach(opt => { const el = document.createElement('option'); el.value = opt; el.textContent = opt; select.appendChild(el); });
            }
            select.value = Array.from(select.options).map(o => o.value).includes(selectedValue) ? selectedValue : (key === 'timeframe' ? 'all_time' : 'all');
        }
        
        function createDonutChart(percentage) {
            const size = 46;
            const strokeWidth = 4;
            const radius = (size / 2) - strokeWidth;
            const center = size / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percentage / 100) * circumference;
            let colorClass = 'red';
            if (percentage > 75) colorClass = 'dark-green';
            else if (percentage > 50) colorClass = 'light-green';
            else if (percentage > 25) colorClass = 'yellow';
            const textContent = percentage === 100 ? '✔️' : `${percentage}%`;
            const fontSize = percentage === 100 ? '14px' : '12px';
            return `<svg class="progress-donut" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle class="progress-donut-bg" r="${radius}" cx="${center}" cy="${center}" stroke-width="${strokeWidth}"></circle><circle class="progress-donut-fg ${colorClass}" r="${radius}" cx="${center}" cy="${center}" stroke-width="${strokeWidth}" stroke-dasharray="${circumference} ${circumference}" stroke-dashoffset="${offset}"></circle><text class="progress-donut-text" x="${center}" y="${center}" transform="rotate(90 ${center} ${center})" style="font-size: ${fontSize};">${textContent}</text></svg>`;
        }
        
        // === FUNCIÓN renderTable ACTUALIZADA ===
        function renderTable(data) {
            const getSortString = o => { 
                const ps = getPackingStatus(o);
                const ip = ps === 'being_packed';
                const u = ip ? '1' : '2';
                const key = `${o.id_marketer_order}-${o.codigo_producto}`;
                const l = ip ? (state.lines[key]?.[0] || 'Z') : 'Z';
                const p = state.priorities[o.load] || 999;
                const lo = o.load || 'ZZZ';
                const sd = DateTime.fromFormat(o.fecha_envio, dateFormat).toISODate() || '9999-12-31';
                const m = o.marketer || '~';
                const on = String(o.order_number || '~').padStart(10, '0');
                return `${u}-${l}-${p.toString().padStart(3, '0')}-${lo}-${sd}-${m}-${on}`;
            };
            const sortedData = [...data].sort((a, b) => getSortString(a).localeCompare(getSortString(b)));
            const finalData = sortedData.filter(o => (parseFloat(o.cajas_por_pallet) || 0) > 0 && (parseFloat(o.cantidad_solicitada) / (parseFloat(o.cajas_por_pallet) || 1)) > 0);
            if (finalData.length === 0) { tableContainer.innerHTML = `<p class="loading">No orders match the current filters.</p>`; return; }
            
            const totals = { request: 0, assigned: 0, pending: 0, balancePounds: 0, shipped: 0 };
            finalData.forEach(o => { 
                const reqC = parseFloat(o.cantidad_solicitada) || 0, assC = parseFloat(o.cantidad_asignada) || 0, shipC = parseFloat(o.cantidad_despachada) || 0, pC = parseFloat(o.peso_por_caja) || 0, cxp = parseFloat(o.cajas_por_pallet) || 1;
                const reqN = reqC / cxp, assN = assC / cxp, shipN = shipC / cxp;
                totals.request += reqN; 
                totals.assigned += assN; 
                totals.pending += reqN - (assN + shipN); 
                totals.balancePounds += (reqC - (assC + shipC)) * pC; 
                totals.shipped += shipN;
            });
            const totalsRowHTML = `<tr class="totals-row">
                <td colspan="12"></td>
                <td class="numeric-cell">${totals.request.toFixed(2)}</td>
                <td class="numeric-cell">${totals.assigned.toFixed(2)}</td>
                <td class="numeric-cell">${totals.pending.toFixed(2)}</td>
                <td class="numeric-cell">${totals.balancePounds.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td class="col-availability"></td>
                <td class="col-availability"></td>
                <td class="numeric-cell">${totals.shipped.toFixed(2)}</td>
                <td class="col-price"></td>
                <td class="col-receiver"></td>
                <td class="col-address"></td>
                <td class="col-boxes-pallet"></td>
                <td class="col-pound-box"></td>
            </tr>`;
            
            const loadOwnership = new Map(); allOrders.forEach(o => { const load = state.loads[o.id_marketer_order]; if (o.estado_marketer_order === 'activa' && load && !loadOwnership.has(load)) { loadOwnership.set(load, o.marketer); } });
            const allUsedLoads = Array.from(new Set(Object.values(state.loads))).sort(compareLoads);
            const nextAvailableGlobalLoad = getNextAvailableLoad(allUsedLoads);
            const occupiedLines = new Set(Object.values(state.lines).flat());
            const existingPriorities = Object.values(state.priorities);
            const maxPriority = existingPriorities.length > 0 ? Math.max(...existingPriorities) : 0;
            
            const rowsToFlashForLoadCompletion = new Set();
            const loadsData = finalData.reduce((acc, order) => {
                const loadId = state.loads[order.id_marketer_order];
                if (!loadId) return acc;
                if (!acc[loadId]) acc[loadId] = [];
                acc[loadId].push(order);
                return acc;
            }, {});

            for (const loadId in loadsData) {
                let requestSum = 0;
                let assignedSum = 0;
                const candidateOrders = [];

                loadsData[loadId].forEach(order => {
                    if (getPackingStatus(order) !== 'being_packed') {
                        const cxp = parseFloat(order.cajas_por_pallet) || 1;
                        requestSum += (parseFloat(order.cantidad_solicitada) || 0) / cxp;
                        assignedSum += (parseFloat(order.cantidad_asignada) || 0) / cxp;
                        candidateOrders.push(order);
                    }
                });

                const deficit = requestSum - assignedSum;
                if (deficit > 0.99 && deficit < 1.01) {
                    candidateOrders.forEach(order => {
                        const cxp = parseFloat(order.cajas_por_pallet) || 1;
                        const reqN = (parseFloat(order.cantidad_solicitada) || 0) / cxp;
                        const assN = (parseFloat(order.cantidad_asignada) || 0) / cxp;
                        if (reqN - assN > 0) {
                            rowsToFlashForLoadCompletion.add(`${order.id_marketer_order}-${order.codigo_producto}`);
                        }
                    });
                }
            }

            const loadIsDoneCache = {};

            let lastProcessedLoad = null, colorIndex = 0, lastOrderNumberForColor = null;
            const dataRowsHTML = finalData.map((order, index) => {
                const isClosed = order.estado_marketer_order === 'cerrada';
                const packingStatusValue = getPackingStatus(order);
                const assignmentKey = `${order.id_marketer_order}-${order.codigo_producto}`;
                const currentLoad = state.loads[order.id_marketer_order] || '';
                const reqC = parseFloat(order.cantidad_solicitada) || 0, assC = parseFloat(order.cantidad_asignada) || 0, shipC = parseFloat(order.cantidad_despachada) || 0, pC = parseFloat(order.peso_por_caja) || 0, cxp = parseFloat(order.cajas_por_pallet) || 1, disp = parseFloat(order.cantidad_disponible) || 0;
                const reqN = reqC/cxp, assN = assC/cxp, shipN = shipC/cxp, pendN = reqN - (assN+shipN), balP = (reqC - (assC+shipN)) * pC;
                const availP = !isClosed ? Math.floor(disp / cxp) : 0; const availB = !isClosed ? disp - (availP * cxp) : 0;
                
                let packingStatusClasses = `status status-${packingStatusValue}`;
                if (packingStatusValue === 'being_packed') {
                    const pendingPallets = Math.floor(pendN);
                    if (pendingPallets === 2) { packingStatusClasses += ' flash-orange'; } else if (pendingPallets === 1) { packingStatusClasses += ' flash-red'; }
                } else if (rowsToFlashForLoadCompletion.has(assignmentKey)) {
                    packingStatusClasses += ' flash-orange';
                }

                const packingStatusCellHTML = `<td data-label="PACKING STATUS"><span class="${packingStatusClasses}">${packingStatusValue.replace('_', ' ').toUpperCase()}</span></td>`;
                let currentLines = state.lines[assignmentKey];
                if (typeof currentLines === 'string') { currentLines = [currentLines]; } else if (!Array.isArray(currentLines)) { currentLines = []; }
                let lineCellHTML;
                const isLineEligible = !isClosed && ['pending', 'partially', 'being_packed'].includes(packingStatusValue);
                if (isLineEligible) {
                    const lineBtnId = `line-btn-${order.id_marketer_order}-${order.codigo_producto}`;
                    const lineContentId = `line-content-${order.id_marketer_order}-${order.codigo_producto}`;
                    const btnContent = currentLines.length > 0 ? currentLines.join('<br>') : '-';
                    lineCellHTML = `<td class="multiselect-cell" data-label="OUTFEED"><button id="${lineBtnId}" class="multiselect-btn">${btnContent}</button><div id="${lineContentId}" class="multiselect-content">${ALL_LINES.map(line => { const isChecked = currentLines.includes(line); const isOccupied = occupiedLines.has(line) && !isChecked; const disabledClass = isOccupied ? 'class="disabled"' : ''; return `<label ${disabledClass}><input type="checkbox" value="${line}" ${isChecked ? 'checked' : ''} ${isOccupied || !unlockedColumns.line ? 'disabled' : ''}> ${line}</label>`; }).join('')}</div></td>`;
                } else {
                    lineCellHTML = `<td data-label="OUTFEED" style="text-align: left; font-weight: bold;">${currentLines.join('<br>') || '-'}</td>`;
                }
                const currentPriority = state.priorities[currentLoad];
                
                let loadCellHTML;
                let loadDef = null; 
                if (currentLoad) {
                    if (lastOrderNumberForColor !== order.order_number) { 
                        if (lastProcessedLoad !== currentLoad) { 
                            colorIndex = 1 - colorIndex; 
                            lastProcessedLoad = currentLoad; 
                        } 
                        lastOrderNumberForColor = order.order_number; 
                    } 
                    loadDef = LOAD_COLORS[colorIndex];
                }

                const isLoadDisabled = !!currentPriority || !unlockedColumns.load || isClosed || packingStatusValue === 'shipped';
                if (isLoadDisabled) {
                    const bgColor = currentLoad ? loadDef.background : '#f0f2f5';
                    const textColor = currentLoad ? loadDef.text : '#aaa';
                    loadCellHTML = `<td data-label="LOAD"><span class="cell-tag" style="background-color: ${bgColor}; color: ${textColor};">${currentLoad || '-'}</span></td>`;
                } else {
                    const marketerLoads = []; 
                    loadOwnership.forEach((owner, load) => { if (owner === order.marketer) marketerLoads.push(load); });
                    const uniqueOpts = [...new Set([...marketerLoads, nextAvailableGlobalLoad, currentLoad].filter(Boolean))].sort(compareLoads);
                    const bgColor = loadDef ? loadDef.background : 'transparent';
                    const textColor = loadDef ? loadDef.text : '#000';
                    loadCellHTML = `<td data-label="LOAD"><div class="tag-select-wrapper"><span class="cell-tag" style="background-color:${bgColor}; color:${textColor};">${currentLoad || '-'}<select class="load-select" style="color:${textColor};" onchange="handleLoadChange('${order.id_marketer_order}', this.value)"><option value="">${currentLoad ? 'Clear' : '-'}</option>${uniqueOpts.map(l => `<option value="${l}" ${currentLoad === l ? 'selected' : ''}>${l}</option>`).join('')}</select></span></div></td>`;
                }
                
                let isLoadDoneForPriority = false;
                if (currentLoad && loadIsDoneCache[currentLoad] === undefined) {
                    const ordersInLoad = allOrders.filter(o => state.loads[o.id_marketer_order] === currentLoad);
                    loadIsDoneCache[currentLoad] = ordersInLoad.every(o => getPackingStatus(o) === 'done' || getPackingStatus(o) === 'shipped');
                }
                if (currentLoad) {
                    isLoadDoneForPriority = loadIsDoneCache[currentLoad];
                }
                
                // === INICIO: LÓGICA DE PRIORIDAD MODIFICADA ===
                let priorityCellHTML;
                const isPriorityDisabled = !unlockedColumns.priority || isLoadDoneForPriority || !currentLoad || isClosed || packingStatusValue === 'being_packed' || packingStatusValue === 'shipped';
                
                let capsuleContent = `<span>${currentPriority || '-'}</span>`;
                if (currentPriority && currentPriority >= 1 && currentPriority <= 3) {
                    const iconSVG = `<svg class="priority-icon p${currentPriority}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.034a.75.75 0 01.65.375l10 17.5a.75.75 0 01-.65 1.125H2a.75.75 0 01-.65-1.125l10-17.5A.75.75 0 0112 2.034zm0 1.466L3.03 19.5h17.94L12 3.5zM11.25 8.25a.75.75 0 011.5 0v6a.75.75 0 01-1.5 0v-6zm.75 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" fill-rule="evenodd"/></svg>`;
                    capsuleContent = `<span>${currentPriority}</span>${iconSVG}`;
                }

                const noPriorityStyle = !currentPriority ? 'style="background-color: white; border-color: transparent;"' : '';

                if (isPriorityDisabled) {
                    priorityCellHTML = `<td data-label="PRIORITY"><div class="priority-capsule" ${noPriorityStyle}>${capsuleContent}</div></td>`;
                } else {
                    let optsHTML = `<option value="">-</option>`;
                    for(let i=1; i<=maxPriority+1; i++) { 
                        const taken = existingPriorities.includes(i) && i !== currentPriority;
                        optsHTML += `<option value="${i}" ${currentPriority === i ? 'selected' : ''} ${taken ? 'disabled style="color:#ccc;"' : ''}>${i}${taken ? ' (taken)' : ''}</option>`;
                    }
                    const selectHTML = `<select class="priority-select" onchange="handlePriorityChange('${currentLoad}', this.value)">${optsHTML}</select>`;
                    priorityCellHTML = `<td data-label="PRIORITY"><div class="priority-capsule" ${noPriorityStyle}>${capsuleContent}${selectHTML}</div></td>`;
                }
                // === FIN: LÓGICA DE PRIORIDAD MODIFICADA ===

                const hoy = DateTime.now().startOf('day');
                const shipDateObj = DateTime.fromFormat(order.fecha_envio, dateFormat).startOf('day');
                let shipDateCell;
                if (shipDateObj.isValid) {
                    let contentHTML = `<span class="date-text">${order.fecha_envio}</span>`;
                    if (shipDateObj < hoy) {
                        shipDateCell = `<td data-label="SHIP DATE"><div class="date-indicator"><span class="symbol">&lsaquo;</span>${contentHTML}</div></td>`;
                    } else if (shipDateObj.hasSame(hoy, 'day')) {
                        shipDateCell = `<td data-label="SHIP DATE"><div class="date-indicator">${contentHTML}</div></td>`;
                    } else {
                        shipDateCell = `<td data-label="SHIP DATE"><div class="date-indicator">${contentHTML}<span class="symbol">&rsaquo;</span></div></td>`;
                    }
                } else {
                    shipDateCell = `<td data-label="SHIP DATE">${order.fecha_envio}</td>`;
                }
                const marketerName = order.marketer;
                const logoFile = logoMap[marketerName];
                let marketerCellHTML;
                if (showLogos && logoFile) {
                    marketerCellHTML = `<td data-label="MARKETER" style="text-align:center;"><img src="/logos/${logoFile}" class="client-logo" alt="${marketerName}" onerror="this.outerHTML = '<span>${marketerName}</span>'"></td>`;
                } else {
                    marketerCellHTML = `<td data-label="MARKETER" style="text-align:center;">${marketerName}</td>`;
                }
                let percentCell = '<td data-label="%"></td>';
                if (reqN > 0) {
                    const pct = Math.min(100, Math.round(((assN + shipN) / reqN) * 100));
                    percentCell = `<td data-label="%">${createDonutChart(pct)}</td>`;
                }
                const organicIcon = order.formacion && order.formacion.toLowerCase().includes('organic') ? '🌿 ' : '';
                
                const current_cxp = parseFloat(order.cajas_por_pallet) || 1;
                let availBoxesText = `${availB}`;
                if (availB > 0 && availB < current_cxp) {
                    const needed = current_cxp - availB;
                    availBoxesText = `${availB} (${needed})`;
                }
                
                const packStyleHTML = `${order.descripcion}<br><span class="pack-style-id">(${order.codigo_producto})</span>`;
                const orderNumberHTML = `${order.order_number}<br><span class="order-id-subtext">(${order.id_marketer_order})</span>`;
                const labelText = (order.label || '').replace(/organic/ig, '').trim();
                return `<tr>
                    <td data-label="COMMERCIAL STATUS"><span class="status status-${isClosed ? 'closed' : 'open'}">${isClosed ? 'CLOSED' : 'OPEN'}</span></td>
                    ${packingStatusCellHTML}
                    ${lineCellHTML}
                    ${priorityCellHTML}
                    ${loadCellHTML}
                    ${shipDateCell}
                    ${marketerCellHTML}
                    <td data-label="ORDER NUMBER" style="text-align:left;">${orderNumberHTML}</td>
                    <td data-label="PACK STYLE" style="text-align:left;">${packStyleHTML}</td>
                    <td data-label="LABEL" style="text-align:left;">${labelText}</td>
                    <td data-label="PRODUCTION METHOD" style="text-align:left;">${organicIcon}${order.formacion || ''}</td>
                    ${percentCell}
                    <td class="numeric-cell" data-label="REQUEST"><span class="numeric-value">${reqN.toFixed(2)}</span></td>
                    <td class="numeric-cell" data-label="ASSIGNED"><span class="numeric-value">${assN.toFixed(2)}</span></td>
                    <td class="numeric-cell" data-label="PENDING"><span class="numeric-value pending">${pendN.toFixed(2)}</span></td>
                    <td class="numeric-cell" data-label="BALANCE POUND"><span class="numeric-value">${balP.toLocaleString('en-US',{maximumFractionDigits:0})}</span></td>
                    <td class="numeric-cell col-availability" data-label="AVAILABLE PALLETS">${availP > 0 ? `<span class="numeric-capsule">${availP}</span>` : `<span class="numeric-value">${availP}</span>`}</td>
                    <td class="numeric-cell col-availability" data-label="AVAILABLE BOXES">${availB > 0 ? `<span class="numeric-capsule">${availBoxesText}</span>` : `<span class="numeric-value">${availBoxesText}</span>`}</td>
                    <td class="numeric-cell" data-label="SHIPPED"><span class="numeric-value">${shipN.toFixed(2)}</span></td>
                    <td class="col-price numeric-cell" data-label="PRICE">$${(parseFloat(order.precio) || 0).toFixed(2)}</td>
                    <td class="col-receiver" style="text-align:left;" data-label="RECEIVER">${order.recibidor}</td>
                    <td class="col-address" data-label="ADDRESS"><a href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent('2460 Wildwood RD Curtis WA 98538')}&destination=${encodeURIComponent(order.direccion_recibidor)}" target="_blank" class="address-link">${order.direccion_recibidor}</a></td>
                    <td class="col-boxes-pallet numeric-cell" data-label="BOXES/PALLET">${order.cajas_por_pallet}</td>
                    <td class="col-pound-box numeric-cell" data-label="LBS/BOX">${order.peso_por_caja}</td>
                </tr>`;
            }).join('');

            tableContainer.innerHTML = `<div class="table-wrapper"><table><thead><tr>
                <th>COMMERCIAL<br>STATUS</th><th>PACKING<br>STATUS</th><th>OUTFEED</th><th>PRIORITY</th><th>LOAD</th><th>SHIP<br>DATE</th>
                <th>MARKETER</th><th>ORDER<br>NUMBER</th><th>PACK<br>STYLE</th><th>LABEL</th><th>PRODUCTION<br>METHOD</th><th>%</th>
                <th>REQUEST</th><th>ASSIGNED</th><th>PENDING</th><th>BALANCE<br>POUND</th><th class="col-availability">AVAILABLE<br>PALLETS</th><th class="col-availability">AVAILABLE<br>BOXES</th><th>SHIPPED</th>
                <th class="col-price">PRICE</th><th class="col-receiver">RECEIVER</th><th class="col-address">ADDRESS</th><th class="col-boxes-pallet">BOXES<br>PALLET</th><th class="col-pound-box">LBS<br>BOX</th>
            </tr></thead><tbody>${totalsRowHTML}${dataRowsHTML}</tbody></table></div>`;
            
            const tableBody = tableContainer.querySelector('tbody');
            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    const lineBtn = e.target.closest('.multiselect-btn');
                    if (lineBtn && lineBtn.id.startsWith('line-btn-')) {
                        if (!unlockedColumns.line) return; 
                        e.stopPropagation();
                        const content = lineBtn.nextElementSibling;
                        document.querySelectorAll('.multiselect-cell .multiselect-content').forEach(c => { if(c !== content) c.style.display = 'none'; });
                        content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    }
                });

                tableBody.addEventListener('change', (e) => {
                    const checkbox = e.target;
                    if (checkbox.type === 'checkbox' && checkbox.closest('.multiselect-content')) {
                        const content = checkbox.closest('.multiselect-content');
                        const row = checkbox.closest('tr');
                        const orderIdCell = row.querySelector('[data-label="ORDER NUMBER"] .order-id-subtext');
                        const orderId = orderIdCell.textContent.replace(/[()]/g, '');
                        const packStyleCell = row.querySelector('[data-label="PACK STYLE"] .pack-style-id');
                        const standardId = packStyleCell.textContent.replace(/[()]/g, '');
                        const selectedLines = Array.from(content.querySelectorAll('input:checked')).map(cb => cb.value);
                        handleLineChange(orderId, standardId, selectedLines);
                    }
                });
            }
        }
        
        // ========== EVENT LISTENERS & INITIALIZATION ==========
        function setupEventListeners() {
            document.getElementById('timerBtn').addEventListener('click', () => { if (timerRunning) stopTimer(); else startTimer(); });
            
            const updateButton = document.getElementById('updateBtn');
            updateButton.addEventListener('click', () => {
                const svg = updateButton.querySelector('svg');
                svg.classList.add('spinning');
                refreshData();
                svg.addEventListener('animationend', () => {
                    svg.classList.remove('spinning');
                }, { once: true });
            });
            
            document.getElementById('showLogosCheckbox').addEventListener('change', (e) => {
                showLogos = e.target.checked;
                applyFiltersAndRender();
            });

            document.getElementById('setLineBtn').addEventListener('click', () => handleAuthAction('line'));
            document.getElementById('setPriorityBtn').addEventListener('click', () => handleAuthAction('priority'));
            document.getElementById('setLoadBtn').addEventListener('click', () => handleAuthAction('load'));
            document.getElementById('setAllBtn').addEventListener('click', () => handleAuthAction('all'));
            document.getElementById('togglePriceBtn').addEventListener('click', () => handleToggleAuth('price'));
            
            document.getElementById('toggle-panel-btn').addEventListener('click', () => {
                document.body.classList.toggle('controls-collapsed');
            });

            function setupToggleButton(btnId, className, defaultText) {
                 const btn = document.getElementById(btnId);
                 btn.addEventListener('click', (e) => {
                    document.body.classList.toggle(className);
                    e.target.textContent = e.target.textContent.startsWith('Show') ? `Hide ${defaultText}` : `Show ${defaultText}`;
                    e.target.classList.toggle('active');
                 });
            }
            setupToggleButton('toggleAddressBtn', 'show-address', 'Address');
            setupToggleButton('toggleReceiverBtn', 'show-receiver', 'Receiver');
            setupToggleButton('toggleAvailabilityBtn', 'show-availability', 'Availability');
            setupToggleButton('toggleBoxesPalletBtn', 'show-boxes-pallet', 'Boxes/Pallet');
            setupToggleButton('togglePoundBoxBtn', 'show-pound-box', 'Lbs/Box');
            
            Object.values(filters).forEach(filter => filter.addEventListener('change', applyFiltersAndRender));
            const shipDateBtn = document.getElementById('shipDateFilterBtn');
            const shipDateContent = document.getElementById('shipDateFilterContent');
            shipDateBtn.addEventListener('click', (e) => { e.stopPropagation(); shipDateContent.style.display = shipDateContent.style.display === 'block' ? 'none' : 'block'; });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.multiselect-filter')) shipDateContent.style.display = 'none';
                if (!e.target.closest('.multiselect-cell')) {
                    document.querySelectorAll('.multiselect-cell .multiselect-content').forEach(c => c.style.display = 'none');
                }
            });
            document.getElementById('defaultFiltersBtn').addEventListener('click', () => {
                filters.commercialStatus.value = 'open'; filters.packingStatus.value = 'all'; filters.timeframe.value = 'today_past';
                selectedShipDates.clear();
                Object.keys(filters).forEach(k => { if (!['commercialStatus', 'packingStatus', 'timeframe'].includes(k)) filters[k].value = 'all'; });
                applyFiltersAndRender();
            });
        }
        function populateShipDateFilter(data) {
            const content = document.getElementById('shipDateFilterContent');
            const dates = Array.from(new Set(data.map(o => o.fecha_envio))).sort((a,b) => DateTime.fromFormat(a, dateFormat) - DateTime.fromFormat(b, dateFormat));
            content.innerHTML = '';
            const allLabel = document.createElement('label'); const allCB = document.createElement('input'); allCB.type = 'checkbox'; allCB.checked = selectedShipDates.size === 0;
            allCB.onchange = (e) => { if(e.target.checked) { selectedShipDates.clear(); content.querySelectorAll('input').forEach(cb => { if (cb !== allCB) cb.checked = false; }); } updateShipDateButtonText(); applyFiltersAndRender(); };
            allLabel.append(allCB, ' (Select All)'); content.appendChild(allLabel);
            dates.forEach(date => { const label = document.createElement('label'), cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = date; cb.checked = selectedShipDates.has(date);
                cb.onchange = (e) => { if (e.target.checked) selectedShipDates.add(date); else selectedShipDates.delete(date); content.querySelector('input').checked = selectedShipDates.size === 0; updateShipDateButtonText(); applyFiltersAndRender(); };
                label.append(cb, ` ${date}`); content.appendChild(label);
            });
            updateShipDateButtonText();
        }
        function updateShipDateButtonText() { const btn = document.getElementById('shipDateFilterBtn'); if (selectedShipDates.size === 0) btn.textContent = 'All'; else if (selectedShipDates.size === 1) btn.textContent = selectedShipDates.values().next().value; else btn.textContent = `${selectedShipDates.size} dates selected`; }
        function refreshData() { loadAndRenderAll(true); }
        
        async function loadAndRenderAll(keepFilters) {
            const prevSelections = keepFilters ? Object.fromEntries(Object.entries(filters).map(([k,v]) => [k,v.value])) : {};
            tableContainer.innerHTML = `<p class="loading">Cargando datos de órdenes y logos...</p>`;
            const [ordersResponse, logosResponse] = await Promise.all([
                apiCall('/api/orders'),
                apiCall('/api/logos')
            ]);
            if (!ordersResponse.success || !Array.isArray(ordersResponse[0]?.data)) {
                tableContainer.innerHTML = `<p class="error">Error: No se pudieron cargar los datos de las órdenes desde la API externa.</p>`;
                return;
            }
            allOrders = ordersResponse[0].data.filter(o => ['cerrada', 'activa'].includes(o.estado_marketer_order) && o.fecha_envio);
            if (logosResponse.success && Array.isArray(logosResponse.data)) {
                logoMap = logosResponse.data.reduce((acc, item) => {
                    acc[item.marketer_name] = item.logo_filename;
                    return acc;
                }, {});
            } else {
                console.warn("No se pudieron cargar los logos de los marketers. Se usarán iniciales.");
                logoMap = {};
            }
            tableContainer.innerHTML = `<p class="loading">Reconciliando y actualizando estado...</p>`;
            const reconcileResponse = await apiCall('/api/reconcile', 'POST');
            if (!reconcileResponse.success || !reconcileResponse.state) {
                tableContainer.innerHTML = `<p class="error">Fallo en la carga de estado. Por favor, revise la consola del servidor y recargue.</p>`
                return;
            }
            state = reconcileResponse.state;
            filterKeys.forEach(k => { if (k !== 'commercialStatus' && k !== 'packingStatus') { populateFilterOptions(k, allOrders, 'all'); } });
            if (keepFilters) {
                Object.keys(prevSelections).forEach(k => { if(filters[k]) filters[k].value = prevSelections[k]; });
            } else {
                filters.commercialStatus.value = 'open';
                filters.packingStatus.value = 'all';
                filters.timeframe.value = 'today_past';
            }
            applyFiltersAndRender();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadAndRenderAll(false);
            updateActionButtonsState();
        });
    </script>
</body>
</html>